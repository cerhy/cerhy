/* rev 180220, (c) dbs, ghljj.com */
String.implement({query:function(a,b){var c=new RegExp('[/?&]'+a+'=([^&#]*)?');var d=this.match(c);if(b!=undefined){b=a+'='+b;return d==null?this+(this.indexOf('?')<0?'?':'&')+b:this.replace(c,d[0].substr(0,1)+b)}else return d!=null?d[1]:''},utc:function(a){if(this.indexOf('T')<0)return this;var d=this.replace('T',' ');switch(a){case'mdhn':return d.substr(5,11);case'ymdhn':return d.substr(0,16);case'ymd':return d.substr(0,10);case'md':return d.substr(5,5);default:var b=new Date(),dt1=d.utcDate(),dt2=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);var c=Math.floor((dt2-dt1)/86400000);switch(c){case 0:return'\u4eca\u5929 '+d.substr(11,5);case 1:return'\u6628\u5929 '+d.substr(11,5);case 2:return'\u524d\u5929 '+d.substr(11,5);default:return(dt2.getFullYear()-dt1.getFullYear())>0?d.substr(0,a=='f'?16:10):d.substr(5,11)}}},utcDate:function(){var a=this.split(/[- :T]/);return new Date(a[0],a[1]-1,a[2],a[3]||0,a[4]||0,a[5]||0)},html:function(){return this.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\x20\x20/g,'&nbsp; ').replace(/\t/g,'&nbsp; ').replace(/\"/g,'&quot;').replace(/\n/g,'<br>')},toHtml:function(){return/(<([^>]+)>)/ig.test(this)?this.wipeScript():this.replace(/\n/g,'<br>')},stripHtml:function(){return this.replace(/(<([^>]+)>)/ig,'').replace(/&nbsp;/ig,' ').replace(/&lt;/ig,'<').replace(/&gt;/ig,'>').replace(/&amp;/ig,'&')},padLeft:function(a,b){if(!b)b='0';var c='';for(var i=0,j=a-this.length;i<j;i++)c=c+b;return c+this},getExtension:function(){return this.substr(this.lastIndexOf('.')+1).toLowerCase()},getFileType:function(){var a=this.getExtension();if(['jpg','png','gif'].indexOf(a)>-1)return'image';else if(['doc','docx','xls','xlsx','ppt','pptx','pdf'].indexOf(a)>-1)return'owa';else if(['mp3','aac'].indexOf(a)>-1)return'audio';else if('mp4'==a)return'video';else return''},isImage:function(){return this.getFileType()=='image'},isOwa:function(){return this.getFileType()=='owa'},thousands:function(){return this.replace(/(\d{1,3})(?=(\d{3})+(?:$|\.))/g,'$1,')},round:function(a){var d=this.toFloat();return isFinite(d)&&d!=0?d.round(a):''},dbc2sbc:function(){return this.replace(/[\uff01-\uff5e]/g,function(a){return String.fromCharCode(a.charCodeAt(0)-65248)}).replace(/\u3000/g,' ')},wipeScript:function(){var e=function(s){return s.replace(/<(script)(.|\n)*\/\1>\s*/ig,'')};var f=function(s){return s.replace(/<[a-z][^>]*\s*on[a-z]+\s*=[^>]+/ig,function(a,b){return a.replace(/\s*on[a-z]+\s*=\s*("[^"]+"|'[^']+'|[^\s]+)\s*/ig,'')})};var g=function(s){return s.replace(/<[a-z][^>]*\s*(href|src)\s*=[^>]+/ig,function(c,d){c=c.replace(/&#(6[5-9]|[78][0-9]|9[0789]|1[01][0-9]|12[012]);?/g,function(a,b){return String.fromCharCode(b)});return c.replace(/\s*(href|src)\s*=\s*("\s*(javascript|vbscript):[^"]+"|'\s*(javascript|vbscript):[^']+'|(javascript|vbscript):[^\s]+)/ig,'')})};var h=function(s){return s.replace(/<[a-z][^>]*\s*style\s*=[^>]+/ig,function(c,d){c=c.replace(/&#(6[5-9]|[78][0-9]|9[0789]|1[01][0-9]|12[012]);?/g,function(a,b){return String.fromCharCode(b)});return c.replace(/\s*style\s*=\s*("[^"]+(expression)[^"]+"|'[^']+\2[^']+'|[^\s]+\2[^\s]+)\s*/ig,'')})};return e(f(g(this)))}});Array.implement({shuffle:function(){for(var i=this.length;i&&--i;){var a=this[i],r=Math.floor(Math.random()*(i+1));this[i]=this[r];this[r]=a};return this},getIndex:function(a,b){for(var i=0,l=this.length;i<l;i++){if(a.call(b,this[i],i,this))return i};return-1},find:function(a,b){var c=this.getIndex(a,b);return c>=0?this[c]:null}});Date.implement({span:function(){var d=new Date();var a=d.getTime()-this.getTime();return a}});
Element.implement({visible:function(){return this.style.display!='none'},display:function(a){this.style.display=(a==false?'none':'');return this},displayToggle:function(){return this.display(!this.visible())},displayGroup:function(b){this.getElements('*[_group]').each(function(a){a.display(b[a.get('_group')])});return this},singleSelect:function(a){this.addClass('active').getSiblings(a).removeClass('active');return this},tip:function(a){new StickDlg({stickTo:this,html:a});return this},checkAnchor:function(e){if(!e)e=['/admin/','script:'];this.addEvent('click',function(b){var c=b.target;if(c.tagName.toLowerCase()!='a')c=c.getParent('a');if(!c)return;var d=c.get('href');if(e.some(function(a){return d.indexOf(a)>-1})){c.tip('\u6b64\u94fe\u63a5\u53ef\u80fd\u4e0d\u5b89\u5168');b.stop()}});return this},fillOptionsFromArray:function(e,f){var g=this.empty();e.each(function(a,b){var c=document.createElement('OPTION');var d=f(a,b);c.value=d.value;c.innerHTML=d.html;c.selected=d.selected;if(d.selected)c.defaultSelected=true;g.appendChild(c)});return g},fillOptions:function(d,e,f){var g=this;var h=function(a,b,p){var c=document.createElement('OPTION');c.value=f?b:a;c.innerHTML=f?a:b;if((p==0&&!(e||e===0))||a==e){c.selected=true;c.defaultSelected=true};g.appendChild(c)};var j=0;if(typeOf(d)=='array'){for(var i=0,l=d.length;i<l;i++)h(d[i],d[i],i)}else{var k=d.__seq__;if(k){for(var i=0,l=k.length;i<l;i++)h(k[i],d[k[i]],i)}else{for(var p in d)h(p,d[p],j++)}};return this},pinReady:function(b,c){var d=this,c=$(c);var e=(d.get('_pin')||'def')+'-pin';b=$(b);if(!b)b=window;var f=Browser.ie6;var g,height,stickHeight;var h=d.getStyle('position');var i=function(){if(!d){b.removeEvent('scroll',i);return};if(!d.isVisible())return;var a=d.retrieve('dbs:_pined');if(!a){g=d.offsetTop;height=d.offsetHeight;stickHeight=c?c.offsetTop+c.offsetHeight:0};var y=b.getScroll().y;if(stickHeight>0&&y>stickHeight)y=0;if(y>g){if(!a){d.setStyles({position:'fixed',top:b.getPosition().y})};if(f)d.setStyles({position:'absolute',top:y});d.store('dbs:_pined',true).addClass(e)}else{d.setStyles({position:h,top:g});d.store('dbs:_pined',false).removeClass(e)}};if(f)b.attachEvent('onscroll',i);else b.addEvent('scroll',i);return this}});(function(){var a='(max-width: 960px)';Browser.portable=(window.matchMedia&&window.matchMedia(a).matches)||(window.styleMedia&&window.styleMedia.matchMedium(a));var b=document.createElement('input');Browser.placeholder=('placeholder'in b);Browser.animation=b.style.animationName!==undefined;delete b})();
(function(){var e,curDrop,activeClass='active',clearHandled=false;var f=function(){if(e){curDrop.removeClass(activeClass);e.hide();curDrop=null;e=null}};var g=function(a,b){if(a==curDrop)return;f();curDrop=a.addClass(activeClass);var c={relativeTo:curDrop,position:'bottomLeft'};if(curDrop.hasClass('alignRight')||curDrop.getStyle('float')=='right')c={relativeTo:curDrop,edge:'topRight',position:'bottomRight'};else if(curDrop.hasClass('alignTop'))c={relativeTo:curDrop,edge:'bottomLeft',position:'topLeft'};e=b.show().position(c)};var h=function(a,b,x,y){f();b.stickTo=a;curDrop=a.addClass(activeClass);e=b.show().setStyles({'left':x,'top':y})};var i=function(a){if(a.target!=e)f()};var j=function(){if(!clearHandled){$(document).addEvents({'click':i,'contextmenu':i});clearHandled=true}};Element.implement({dropReady:function(b,c){this.addEvent(c||'click',function(a){a.stop();g(this,b)});j();return this},contextReady:function(b,c,d){this.addEvent(d||'contextmenu',function(a){if(c&&!c(a.target,b))return;a.stop();h(a.target,b,a.page.x+1,a.page.y+1)});j();return this}})})();
Element.Events.swipe={onAdd:function(d){var e,startY,active=false;var f=function(a){active=true;e=a.event.touches[0].pageX;startY=a.event.touches[0].pageY};var g=function(a){var b=Element.Events.swipe.swipeWidth;var c=a.event.touches[0].pageX,endY=a.event.touches[0].pageY,diff=c-e,diffY=endY-startY,isLeftSwipe=diff<-b,isRightSwipe=diff>b;if(Math.abs(diffY)>Math.abs(diff)/2)active=false;if(active&&(isRightSwipe||isLeftSwipe)){active=false;d.call(this,{'direction':isRightSwipe?'right':'left','startX':e,'endX':c})}};this.addEvent('touchstart',f);this.addEvent('touchmove',g);var h={};h[d]={'touchstart':f,'touchmove':g};this.store('swipeAddedEvents',h)},onRemove:function(a){$H(this.retrieve('swipeAddedEvents')[a]).each(function(v,k){this.removeEvent(k,v)},this)}};Element.Events.swipe.swipeWidth=80;
var XmlToJsObject=(function(e,f){if(typeof(f)=="undefined"){f=true}var g=(function(a){var b={};if(a.nodeType!=1){return null}if(a.attributes.length>0){if(!f){b['_attributes']={}}for(var i=0;i<a.attributes.length;i++){var c=a.attributes.item(i);if(!f){b['_attributes'][c.nodeName]=c.nodeValue}else{b[c.nodeName]=c.nodeValue}}}if(a.hasChildNodes()){var d=a.firstChild;do{if(d.nodeType==3){if(d.nodeValue.replace(/\s*/,'').length==0){continue}if(typeof(b['_value'])=="undefined"){b['_value']=d.nodeValue}else{if(typeof(b['_value'].push)=="undefined"){b['_value']=[b['_value']]}b['_value'].push(d.nodeValue)}}if(d.nodeType==1){if(typeof(b[d.nodeName])=="undefined"||b[d.nodeName]==null){b[d.nodeName]=g(d)}else{if(typeof(b[d.nodeName].push)=="undefined"){b[d.nodeName]=[b[d.nodeName]]}b[d.nodeName].push(g(d))}}}while((d=d.nextSibling)!=null)}return b});if(typeof(e)=='string'){if(window.DOMParser)e=new DOMParser().parseFromString(e,'text/xml');else{var h=new ActiveXObject("Microsoft.XMLDOM");h.loadXML(e);e=h}};var j=e;if(j.nodeType==9){j=j.firstChild;while(j.nodeType!=1&&j.nodeType!=null){j=j.nextSibling}}return g(j)});if(typeof(MooTools)=='object'){Object.extend('fromXML',XmlToJsObject)};
var XmlData=new Class({initialize:function(a,b){if(!b)a=Object.fromXML(a);var c=this.result=a.Result||{};this.state=c.State;this.data=a},get:function(p){return this.data[p]||{}},gets:function(p,a,b){var c=Array.convert(this.data[p]);return a?this[b=='G'?'group':'sort'](c,a,b):c},sort:function(d,e,f){d.sort(function(l,r){var a=l[e],b=r[e];if(f=='1'||f=='-1'){a=parseInt(a);b=parseInt(b)}else if(f=='1.0'||f=='-1.0'){a=parseFloat(a);b=parseFloat(b)};var c=(f=='a'||f=='A')?a.trim().localeCompare(b.trim()):(a<b?-1:a>b?1:0);return(f=='-1'||f=='-1.0'||f=='A')?-c:c});return d},group:function(b,c){var d={};b.each(function(a){var p=a[c];if(!d[p])d[p]=[];d[p].push(a)});return d}});

var StickDlg=new Class({Implements:[Options],Binds:['reposition','close','destroy','closeQuery'],align:'left',initialize:function(a){this.setOptions(a);var b=this.stickTo=$(a.stickTo||document.body);if(b.retrieve('stickDlg'))return;b.store('stickDlg',true);this.align=b.get('_stick')||a.align;var c=$(a.parent)||b.getParent();var d=this.dlg=new Element('div.stick-dlg').set('html','<em class="stick-ptl'+(this.align=='right'?' stick-ptr':'')+'"></em>'+a.html).inject(c);if(a.klass)d.addClass(a.klass);d.set('tween',{duration:200});if(a.ok){var e=new Element('div.stick-bow').inject(this.dlg);if(!a.custom){new Element('button.stick-btn.stick-spt.ok',{'type':'button','html':'\u786e\u5b9a'}).inject(e);new Element('button.stick-btn.cancel',{'type':'button','html':'\u53d6\u6d88'}).inject(e)};d.getElements('.stick-btn').addEvent('click',this.closeQuery)}else setTimeout(this.close,a.delay||2000);window.addEvent('resize',this.reposition);if(a.scroll){this.scrollEvent=true;window.addEvent('scroll',this.reposition)};this.reposition()},closeQuery:function(a){var b=this.options;var c=a.target;if(c.hasClass('ok')&&b.ok&&!b.ok())return;if(c.hasClass('cancel')&&b.cancel&&!b.cancel())return;this.close()},close:function(){this.dlg.fade('out').get('tween').chain(this.destroy)},destroy:function(){window.removeEvent('resize',this.reposition);if(this.scrollEvent)window.removeEvent('scroll',this.reposition);this.dlg.destroy();this.stickTo.eliminate('stickDlg');this.stickTo=null},reposition:function(){var a=this.align=='right';this.dlg.position({relativeTo:this.stickTo,position:this.stickTo==document.body?'topLeft':(a?'bottomRight':'bottomLeft'),edge:a?'topRight':'topLeft'})}});
var PopupDlg=new Class({Binds:['hide','close'],initialize:function(b){this.expand=b.expand||false;var c=this.box=new Element('div.pop-dlg',{'style':'display:none; width:'+b.width+'px'}).inject(document.body);var d=new Element('div.pop-cap').inject(c);if(b.draggable!=false)c.makeDraggable({handle:d});this.inner=new Element('div.pop-inn',{'html':b.content}).inject(c).addEvent('click',function(a){if(a.target.hasClass('done'))this.hide()}.bind(this));var e=b.modal;if(e>0){var f=function(){if(!b.ok||b.ok())this.close()}.bind(this);var g=new Element('div.pop-bow').inject(c);new Element('button.pop-btn[type=button][html=\u786e\u5b9a]',{events:{click:f}}).inject(g);if(e>1)new Element('button.pop-btn[type=button][html=\u53d6\u6d88]',{events:{click:this.close}}).inject(g)}},show:function(a){var b=this.box.show();this.position();var c=b.getElement('button');if(c)c.focus()},position:function(){var a=this.box;var b=a.getSize();var c=document,d=c.getSize(),dx=d.x,dy=d.y;if(!this.expand&&b.y>=dy&&dy>150){b.y=dy-150;this.inner.setStyle('height',b.y)};b.left=(dx-b.x)/2;b.top=(dy-b.y)/2+c.getScroll().y;a.setStyles(b)},hide:function(){this.box.hide()},close:function(){this.box.destroy();delete this.inner;delete this.box}});PopupDlg.alert=function(a){new PopupDlg({modal:1,width:380,content:typeOf(a)=='string'?a.toHtml():a}).show()};PopupDlg.confirm=function(a,b){new PopupDlg({modal:2,width:380,content:typeOf(a)=='string'?a.toHtml():a,ok:b}).show()};
var UploadForm=new Class({Implements:[Events,Options],options:{feed:'ByUrl',allow:'file',imageExts:['jpg','gif','png'],fileExts:['jpg','gif','png','rar','zip','pdf','doc','ppt','xls','docx','pptx','xlsx','mp3','aac','mp4'],imageMsg:'\u56fe\u7247',fileMsg:'\u56fe\u7247\u3001\u6587\u6863\u548c\u538b\u7f29\u5305',limit:4},initialize:function(a){this.setOptions(a);this[!!window.FormData&&a.mordern?'initByXhr':'initByPost']()},initByPost:function(){var h=this.options;var i=String.uniqueID();var j=h.allow;var k=h[j+'Exts'];var l=h[j+'Msg'];var m=h.feed;var n=h.limit;var o='<iframe id="{id}" name="{id}" style="display:none" src="about:blank"></iframe>'+'<form action="{action}" target="{id}" method="post" enctype="multipart/form-data">'+'<div class="up-pmt"></div>'+'<div class="up-step1"><input name="f0" type="file" size="1" class="up-i"/><button class="up-btn" type="button">\u9009\u62e9\u6587\u4ef6</button><button type="submit" class="up-btn">\u4e0a\u4f20</button></div>'+'<div class="up-step2" style="display:none;"><button type="reset" class="up-btn posting2">\u53d6\u6d88\u4e0a\u4f20</button></div>'+'</form>';var q=h.pane=new Element('div.upload').inject(h.parent).set('html',o.substitute({id:i,action:h.action}));var r=q.getElement('iframe');var t=q.getElement('form');var u=t.getElement('.up-pmt');var v=t.getElement('.up-step1');var w=t.getElement('.up-step2');var x=t.getElement('input[type=file]').setOpacity(0);var y;var z=function(a){u.set('html','&nbsp;');v.display(a==1);w.display(a==2)};r.addEvent('load',function(){var a=r.contentWindow;var b=a.location;if(b.href=='about:blank')return;try{x.value=''}catch(e){};t.reset();var c=a.document;var d=Function.attempt(function(){return c.body.innerHTML})||'';var f=Function.attempt(function(){return c.location.href})||'';var g=m=='ByUrl'?decodeURIComponent(f.query('url')):d;if(g.length>0)this.success(g,y);b.href='about:blank';z(1)}.bind(this));x.addEvent('change',function(){var a=x.value,s=a.substring(a.lastIndexOf('\\')+1);u.set('html',s)});t.addEvents({'submit':function(a){var b=x.value.toLowerCase();var p=b.lastIndexOf('.');var c=b.substr(p+1);if(k.indexOf(c)<0){t.tip(l+'\uff0c\u4e0d\u80fd\u8d85\u8fc7'+n+'M');a.stop();return false};y=b.substring(b.lastIndexOf('\\')+1,p);z(2)},'reset':function(a){z(1)}})},initByXhr:function(j){var j=this.options;var k=j[j.allow+'Exts'];var l='\u62d6\u52a8'+j[j.allow+'Msg']+'\u5230\u8fd9\u91cc\u4e0a\u4f20';var m=j.limit*1048576;var n=j.action.query('XHR','1');var o=j.pane=new Element('div.upload').inject(j.parent);var p=new Element('div.up-pmt',{html:l}).inject(o);var q=new Element('span.up-step1',{html:'<input type="file" multiple size="1" class="up-i"/><button class="up-btn up-pick" type="button">\u9009\u62e9\u6587\u4ef6</button>'}).inject(o);var r=q.getElement('input[type=file]').setOpacity(0).addEvent('change',function(a){x(this.files)});var t=function(a,b){var c=a.substr(a.lastIndexOf('.')+1).toLowerCase();if(k.indexOf(c)<0)return-1;if(b>=m)return-2;return 0};var u=function(a){var s=a+'B';for(var b=["K","M","G","T","P","E","Z","Y"],Multiple=0,Approx=a/1024;Approx>1;Approx/=1024,Multiple++){s=Approx.toFixed(1)+" "+b[Multiple]};return s};var v=this.success.bind(this);var w=function(f,e){var g=f.name,state=t(g,f.size);var h=u(f.size);var i=g+' ('+h+')';p.set('html',i);if(state!=0){p.tip(state=='-1'?'\u4e0d\u5141\u8bb8\u4e0a\u4f20':'\u6587\u4ef6\u592a\u5927');if(e)e.delay(1000);return};new XhrUpload(f,{url:n,withCredentials:true,complete:function(a,b,c,d){v(c,b.substr(0,b.lastIndexOf('.')));e.delay(1000)},onprogress:function(a){if(a.lengthComputable){var b=(a.loaded/a.total*100|0);p.set('html',b+'%: '+i)}},onload:function(){p.set('html','OK: '+i)}})};var x=function(a){var b=a.length,i=0;var c=function(){var f=a[i];if(!f)return;i++;w(f,c)};c()};var y=function(a){a.stopPropagation();a.preventDefault()};var z=function(a){if(!q.isVisible())return;y(a);x(a.dataTransfer.files)};var A=document.body;A.addEventListener('dragover',y,false);A.addEventListener('drop',z,false)},success:function(a,b){this.fireEvent('complete',[a,b])}});
var UploadPane=new Class({Extends:UploadForm,initialize:function(a){this.parent(a);var b=this.options.pane;if(!a.unclear){var c=new Element('button.up-btn[html=\u6e05\u7f29\u7565\u56fe]').inject(b).display(false).addEvent('click',function(){new StickDlg({stickTo:c,html:'\u8981\u6e05\u9664\u7f29\u7565\u56fe\u5417\uff1f\u003c\u0062\u0072\u002f\u003e\u4e0a\u4f20\u7684\u6587\u4ef6\u4e0d\u4f1a\u88ab\u5220\u9664\u3002',ok:function(){this.thumbs.empty();c.display(false);return true}.bind(this)})}.bind(this));this.clearBtn=c};this.thumbs=new Element('div.up-thumb').inject(b).addEvent('mousedown',this.clickThumb.bind(this))},success:function(a,b){this.addThumb(a,b)},selected:function(a){var b=a.tag<0?'<a href="{url}">{title}</a>':'<img src="{url}" alt="{title}" />';this.fireEvent('select',[b.substitute(a),a])},addThumb:function(a,b){var c=this.clearBtn;if(c&&!c.visible())c.display(true);var d=a.substr(a.lastIndexOf('.')).toLowerCase();var e=['.gif','.jpg','.png'].indexOf(d);var f={url:a,tag:e,title:b};var g=this.options;new Element('img.up-img',{_url:f.url,_tag:f.tag,title:f.title,src:f.tag<0?g.downIcon:f.url}).inject(this.thumbs,'top');if(g.autoSelect)this.selected(f)},clickThumb:function(a){a.stop();var b=a.target;if(b.get('_url')){var c={url:b.get('_url'),tag:b.get('_tag'),title:b.title};this.selected(c)}}});var XhrUpload=new Class({initialize:function(b,c){var d=new XMLHttpRequest();d.open('POST',c.url,true);if(c.withCredentials)d.withCredentials=true;var e=function(){};d.onreadystatechange=function(){if(d.readyState!=4)return;d.onreadystatechange=e;var a=d.status>=200&&d.status<300;if(c.complete)c.complete(a,b.name,d.responseText,d.responseXML)};d.onload=c.onload||e;if(d.upload)d.upload.onprogress=c.onprogress||e;var f=new FormData();f.append('file',b);d.send(f)}});
var FormX=new Class({Implements:[Options],options:{required:{type:"required",re:/[^.*]/,msg:"\u4e0d\u80fd\u4e3a\u7a7a"},alpha:{type:"alpha",re:/^[a-z ._-]+$/i,msg:"\u53ea\u5141\u8bb8\u5b57\u6bcd"},alphanum:{type:"alphanum",re:/^[a-z0-9 ._-]+$/i,msg:"\u53ea\u80fd\u662f\u5b57\u6bcd\u548c\u6570\u5b57"},integer:{type:"integer",re:/^[-+]?\d+$/,msg:"\u53ea\u80fd\u662f\u6574\u6570"},real:{type:"real",re:/^[-+]?\d*\.?\d+$/,msg:"\u53ea\u80fd\u662f\u6570\u5b57"},date:{type:"date",re:/^(?:(?!0000)[0-9]{4}([-/.]?)(?:(?:0?[1-9]|1[0-2])\1(?:0?[1-9]|1[0-9]|2[0-8])|(?:0?[13-9]|1[0-2])\1(?:29|30)|(?:0?[13578]|1[02])\1(?:31))|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)([-/.]?)0?2\2(?:29))$/,msg:"\u65e5\u671f\u683c\u5f0f\u4e3a\u5e74\u002d\u6708\u002d\u65e5"},email:{type:"email",re:/^[a-z0-9._%-]+@[a-z0-9.-]+\.[a-z]{2,4}$/i,msg:"\u90ae\u4ef6\u683c\u5f0f\u4e0d\u5bf9"},uri:{type:"uri",re:/^(http|https|ftp)\:\/\/[a-z0-9\-\.]+\.[a-z]{2,3}(:[a-z0-9]*)?\/?([a-z0-9\-\._\?\,\'\/\\\+&amp;%\$#\=~])*$/i,msg:"\u7f51\u5740\u683c\u5f0f\u4e0d\u5bf9"},confirm:{type:"confirm",msg:"\u786e\u8ba4\u5185\u5bb9\u4e0d\u7b26"},idcode:{type:"idcode",re:/(^\d{15}$)|(^\d{17}([0-9]|X|x)$)/,msg:'\u8eab\u4efd\u8bc1\u683c\u5f0f\u4e0d\u5bf9'}},initialize:function(){var d=Array.link(arguments,{frm:Type.isElement,url:Type.isString,success:Type.isFunction,checkout:Type.isFunction});this.setOptions(d);var e=this.form=d.frm;this.options.mode=e.get('d-mode')||'ajax';this.validations=[];e.getElements('*[d-vc]').each(function(b){var c=b.get('d-vc').split(' ');c.each(function(a){if(this.options[a])this.register(b,this.options[a]);if(a.charAt(0)=='=')this.register(b,Object.append(this.options.confirm,{idField:a.substr(1)}))},this)},this);e.addEvents({'submit':this.handleSubmit.bind(this),'reset':this.handleReset.bind(this)});this.enhanceForm(e)},register:function(a,b){a=$(a);a.set('oriTitle',a.get('title'));this.validations.push([a,b]);a.addEvent("blur",function(){this.validate(a,b)}.bind(this))},isChildType:function(a){var b=a.type.toLowerCase();return(b=="radio"||b=="checkbox")},validate:function(a,b){var c=b.type=='confirm'?this.form[b.idField].get('value')==a.get('value'):b.re.test(a.get('value'));this.hilight(a,b,!c);return c},validateChild:function(a,b){var c=this.form[a.get("name")];var d=0;var e=true;for(var i=0;i<c.length;i++){if(c[i].checked){d++;if(!b.re.test(c[i].get('value'))){e=false;break}}};if(d==0&&b.type=="required")e=false;this.hilight(a,b,!e);return e},hilight:function(a,b,c){a.toggleClass('f-err',c);a.set('title',c?b.msg||'':a.get('oriTitle')||'')},validateAll:function(){var b=true;this.validations.each(function(a){if(!this[this.isChildType(a[0])?'validateChild':'validate'](a[0],a[1]))b=false},this);return b},handleReset:function(b){this.validations.each(function(a){this.hilight(a[0],a[1],false)},this)},handleSubmit:function(a){var b=this.options;var c=this.validateAll();if(c&&b.checkout)c=b.checkout();if(!c){if(a)a.stop();return false};if(b.mode!='ajax')return true;if(a)a.stop();this.form.send()},enhanceForm:function(e){Object.append(e,FormXEnhance);if(!Browser.placeholder)e.createOverText();else e.updateOverText=null;var f=this.options;if(f.mode!='ajax')return;var g=function(){e.lock(true)};var h=function(){e.lock(false)};var i=function(a){e.warn('\u63d0\u4ea4\u5931\u8d25, \u8bf7\u7a0d\u540e\u518d\u8bd5')};var j=function(a,b){var c=new XmlData(b);var d=f.success;if(d)d(c,c.state,b,a)};var k=e['Action'];var l=RequestX.provider(f.url,k?k.value:'');e.set('send',{url:l,onSuccess:j,onFailure:i,onRequest:g,onComplete:h})}});
var FormXEnhance={createOverText:function(){this.getElements('[placeholder]').each(function(a){new OverText(a)})},updateOverText:function(){this.getElements('[placeholder]').each(function(a){a.fireEvent('change')})},warn:function(a,b){if(!b)b=this.getElement('[type=submit]');new StickDlg({stickTo:b||this,html:a});return false},lock:function(b){this.locked=b;this.getElements('*[type=submit]').each(function(a){a.disabled=b;a.toggleClass(FormX.posting,b)})},setFieldValue:function(n,a){var b=this[n];if(typeOf(b)=='collection'){for(var i=0,len=b.length;i<len;i++){var c=b[i];if(c.value==a){c.checked=a;break}}}else if(b.type=='checkbox')b.checked=b.value==a;else b.value=a;return b},getFieldValue:function(n){var a=this[n];var b='';if(typeOf(a)=='collection'){for(var i=0,len=a.length;i<len;i++){var c=a[i];if(c.checked){b=c.value;break}}}else if(a.type=='checkbox')b=a.checked?a.value:'';else b=a.value;return b},field:function(n,a){return arguments.length==1?this.getFieldValue(n):this.setFieldValue(n,a)},fromData:function(a){var b=this.elements;for(var i=0,j=b.length;i<j;i++){var c=b[i];var p=c.name;if(!p||p=='Action'||p=='Mode'||!a.hasOwnProperty(p))continue;var d=a[p];switch(c.type){case'checkbox':c.checked=d==c.value;break;case'radio':c.checked=d==c.value;break;default:c.value=d}};if(this.updateOverText)this.updateOverText();return a},toData:function(a,b){var c=this.elements;for(var i=0,j=c.length;i<j;i++){var d=c[i];var p=d.name;if(!p||p=='Action'||p=='Mode'||(b&&b.hasOwnProperty(p)))continue;switch(d.type){case'checkbox':a[p]=d.checked?d.value:'';break;case'radio':if(d.checked)a[p]=d.value;break;default:a[p]=d.value}};if(b)Object.append(a,b);return a}};var OverText=new Class({initialize:function(a){a=$(a);var b=a.get('placeholder');if(!b)return;var c=new Element('label.placeholder',{html:b}).inject(a,'before');if(!a.get('id'))a.set('id','input_'+String.uniqueID());c.set('for',a.get('id'));var d=function(){c.hide()};var e=function(){c[!a.get('value')?'show':'hide']()};a.addEvents({focus:d,blur:e,change:e})}});
var PageSpin=new Class({Implements:[Options,Events],options:{len:5,label:'\u9875\u6b21: {Page}/{PageCount}, \u5171 {RecCount} \u6761',prev:'\u4e0a\u9875',next:'\u4e0b\u9875',jump:'\u8f93\u5165\u9875\u7801\u540e\u6309\u56de\u8f66'},initialize:function(b){this.setOptions(b);var b=this.options;var c=this.pane=($(b.id)||new Element('div.paging')).hide().addEvent('click',this._handleClick.bind(this));if($(b.parent))$(b.parent).adopt(c);var d=b.cmd;var e=function(a){return new Element('span.paging-btn',{cmd:d,html:a}).inject(c)};this.s_label=new Element('div.paging-leg').inject(c);this.s_prev=e(b.prev);this.s_left=e('...');this.s_spot=[];for(var i=0,l=b.len;i<l;i++)this.s_spot.push(e(''));this.s_right=e('...');this.s_next=e(b.next);this.s_sim=e(b.next).hide();this.s_jump=new Element('input.paging-i',{title:this.options.jump}).inject(c).addEvent('keydown',this._jump.bind(this));new Element('div.clr').inject(c);if(b.range)this.update(b.range)},update:function(a){var b=this.pane;if(!a||a.RecCount<=0)return b.display(false);b.display();if(!a.PageCount)a.PageCount=Math.ceil(a.RecCount/a.PageSize);this.range=a;this.adjust(a.Page)},adjust:function(p){var c=this.options;var d=this.range;var e=d.Page.toInt();this.s_label.set('html',c.label.substitute(d));this.s_jump.set('value',e);var f=Math.max(e-1,1),p2=Math.min(e+1,d.PageCount);this.s_prev.set('_ps',f);this.s_next.set('_ps',p2);var g=c.len;var h=Math.floor((p-1)/g);var i=h*g;var j=i+g+1;this.s_left.set('_ps',i-1).display(i>1);this.s_spot.each(function(a,b){var n=i+b+1;a.set({'_ps':n,'html':n}).display(n>=1&&n<=d.PageCount).toggleClass('paging-cur',n==e)},this);this.s_right.set('_ps',j).display(j<=d.PageCount)},_jump:function(a){if(a.key=='enter'){var b=this.range;var c=this.s_jump;a.stop();var p=c.get('value').toInt();if(isNaN(p)||p==b.Page||p<1||p>b.PageCount){this.s_jump.set('value',b.Page);return};var d=this.s_sim.set('_ps',p);if(d.click)d.click();else{var e=document.createEvent('MouseEvent');e.initEvent('click',true,true);d.dispatchEvent(e)}}},_handleClick:function(a){var b=$(a.target);if(b.tagName.toLowerCase()!='span')return;var p=b.get('_ps');if(b==this.s_left||b==this.s_right){a.stop();this.adjust(p)}else{this.range.Page=p;b.set('_Page',p);this.adjust(p);if(!this.options.cmd){a.stop();this.fireEvent('changed',[b,p])}}}});var PageMore=new Class({initialize:function(a){this.btn=new Element('div.page-more[style=display:none]',{cmd:a.cmd}).inject(a.parent)},update:function(a){var b=this.btn;if(!a||a.RecCount<=0)return b.display(false);var c=a.Page.toInt();var d=Math.ceil(a.RecCount/a.PageSize);b.set({html:'\u66f4\u591a ('+a.Page+'/'+d+')','_Page':c+1}).display(c<d)}});
var TopicView=new Class({Implements:[Options],options:{wrapClass:'toc',wrapTag:'div',rowTag:'div'},initialize:function(d){this.setOptions(d);d=this.options;var e=d.wrapClass;Object.append(d,{_wrapClass:e+'-view',_rowClass:e+'-row'});var f=d._rowClass;this.grid=new Element(d.wrapTag,{'class':d._wrapClass}).inject($(d.parent)).addEvent('click',function(a){var b=a.target;var c=b.hasClass(f)?b:b.getParent('.'+f);if(c&&(b.get('cmd')||c.get('cmd')))this.selectRow(c)}.bind(this))},renderRow:function(a,b,c){var d=this.options;if(!b)b=new Element(d.rowTag,{'class':d._rowClass,'_id':a[d.id_name]}).inject(this.grid,c);return b.set('html',d.getRowHtml(a,b))},addRow:function(a,b){return this.renderRow(a,null,b)},updateRow:function(a,b){var c=this.findRow(a[this.options.id_name]);return this.renderRow(a,c,b)},selectRow:function(a){a.singleSelect()},findRow:function(a){return this.grid.getElement('*[_id='+a+']')},findSibling:function(a,b){var c=this.findRow(a);if(!c)return-1;var d=b=='next'?'getNext':'getPrevious';var e=c[d]('[_id]');while(e&&e.get('_id')==a)e=e[d]('[_id]');if(e)this.selectRow(e);return e?e.get('_id'):0},removeRow:function(a){var b=this.findRow(a);if(b)b.dispose()},update:function(a,b){this.grid.empty();if(!a||a.length==0)this.grid.set('html',b);else this.append(a)},append:function(b){b.each(function(a){this.addRow(a)},this)},count:function(){return this.grid.getElements('[_id]').length}});var TopicList=new Class({Extends:TopicView,initialize:function(a){this.parent(a);var b=Object.append(a,{parent:a.spiner||a.parent});this.spin=a.spin||(a.stretch?new PageMore(a):new PageSpin(b))},update:function(a,b,c){if(!this.options.stretch||!b||b.Page=='1'){this.parent(a,c)}else{this.append(a)};this.spin.update(b)}});
var TableView=new Class({Implements:[Options],initialize:function(a){if(a.singleSelect)a.selectMode='single';this.setOptions(a);this.table=new Element('table.table-view').inject(a.parent).addEvent('click',this._handleClick.bind(this));this.updateHeader(a.header)},updateHeader:function(a,b){var c='',r2='';for(var p in a){if(a[p]){c+='<col style="'+a[p]+'"/>';r2+='<td>'+p+'</td>'}};var d='<colgroup><col style="width:38px"/>'+c+'</colgroup><thead><td class="tv-row-holders">#</td>'+r2+'</thead><tbody></tbody>';this.table.set('html',d);this.tbody=this.table.getElement('tbody');this.tag=b},_handleClick:function(a){var b=this.options.selectMode;if(b=='none')return;var c=b=='single';var d=a.target;if(d.hasClass('tv-row-holder')){if(c)return;d.toggleClass('tv-row-on');this.selectRow(d.getParent('tr').toggleClass('tv-row-selected'))}else if(d.hasClass('tv-row-holders')){if(c)return;d.toggleClass('on');var e=d.hasClass('on');this.table.getElements('.tv-row-holder').toggleClass('tv-row-on',e);this.tbody.getElements('tr').toggleClass('tv-row-selected',e);this.selectRow(this.tbody.getFirst())}else{if(d.tagName.toLowerCase()!='tr')d=d.getParent('tr');if(!d||d==this.lastRow)return;if(!d.hasClass('tv-row'))return;this.selectRow(d)}},show:function(a){this.table[a?'show':'hide']()},makeRow:function(a,b,c){return'<td'+(this.options.selectMode?'':' class="tv-row-holder"')+'>'+b+'</td>'+this.options.getRowHtml(a,b,c)},addRow:function(a,b){var c=new Element('tr.tv-row',{'_id':a[this.options.id_name]});if(b){var d=b=='top'?this.tbody.firstChild:b.nextSibling;this.tbody.insertBefore(c,d)}else this.tbody.adopt(c);c.set('html',this.makeRow(a,'*',c));return c},updateRow:function(a,b){var c=this.findRow(a[this.options.id_name]);if(!c)this.addRow(a,b);else c.set('html',this.makeRow(a,'*',c))},selectRow:function(a){if(!a||a==this.lastRow)return;var b=this.options.onSelected;if(b)b(a,this.lastRow);if(this.lastRow)this.lastRow.removeClass('tv-row-actived');this.lastRow=a.addClass('tv-row-actived')},findRow:function(a){return this.tbody.getElement('tr[_id='+a+']')},findSibling:function(a,b){var c=this.findRow(a);if(!c)return-1;var d=$(c[b+'Sibling']);if(d)this.selectRow(d);return d?d.get('_id'):0},removeRow:function(a){var b=this.findRow(a);if(b)b.dispose();if(b==this.lastRow)this.lastRow=null},remove:function(b){b.each(function(a){this.removeRow(a)},this);return b},update:function(c){this.lastRow=null;var d=this.options.id_name;var e='';c.each(function(a,b){e+='<tr class="tv-row" _id="'+a[d]+'">'+this.makeRow(a,b+1)+'</tr>'},this);this.tbody.empty().set('html',e)},empty:function(){this.lastRow=null;this.tbody.empty()},selected:function(){return this.lastRow},checked:function(){var b=[];this.tbody.getElements('.tv-row-on').each(function(a){b.push(a.getParent().get('_id'))});if(b.length==0&&this.lastRow)b.push(this.lastRow.get('_id'));return b},count:function(){return this.tbody.childNodes.length}});var TableList=new Class({Extends:TableView,initialize:function(a){this.parent(a);var b=Object.append(a,{parent:a.spiner||a.parent});this.spin=new PageSpin(b)},update:function(a,b){this.parent(a);this.spin.update(b)}});
var CommentView=new Class({Implements:[Options],initialize:function(a){this.setOptions(a);a=this.options;var b=this.pane=$(a.parent).addEvent('click',this.handleClick.bind(this));if(a.caption)new Element('h2.cv-cap',{html:a.caption}).inject(b);this.grid=new Element('div.comment').inject(b);this.spin=a.stretch?new PageMore(a):new PageSpin(a);this.board=new Element('div.cv-board').inject(b);a.updateBoard(this.board)},addRow:function(a,b){var c=this.options;var d=this.grid;var e=new Element('div.cv-row');c.updateRow(a,e);if(b){var f=b=='top'?d.firstChild:b.nextSibling;d.insertBefore(e,f);e.highlight()}else d.adopt(e)},appendRow:function(a){var b=this.curRow;if(!b)this.pane.scrollIntoView(true);this.addRow(a,b||'top');this.moveBoard()},removeRow:function(a,b){var c=a.get('_id');var d=new StickDlg({stickTo:b,align:'right',html:'\u8981\u5220\u9664\u8fd9\u6761\u8bb0\u5f55\u5417\uff1f',ok:function(){d.destroy();this.moveBoard();a.dispose();this.options.removeRow(c);return false}.bind(this)})},moveBoard:function(a){this.curRow=a;var b=this.options;var c=this.board;if(a){a.highlight().getElement('.cv-inn').adopt(c);c.scrollIntoView(false)}else this.pane.adopt(c);if(this.form)b.moveBoard(this.form,a)},handleClick:function(a){var b=a.target;var c=b.get('_btn');if(!c)return;a.stop();var d=b.getParent('.cv-row');if(c=='Reply')this.moveBoard(d);else if(c=='Cancel')this.moveBoard();else if(c=='Remove')this.removeRow(d,b)},clear:function(a){this.moveBoard();this.spin.update(a);if(!this.options.stretch||!a||a.Page=='1')this.grid.empty()},update:function(b,c){this.clear(c);b.each(function(a){this.addRow(a)},this)}});
var Comment=new Class({Extends:CommentView,initialize:function(a){Object.append(a,{updateBoard:this._updateBoard.bind(this),moveBoard:this._moveBoard.bind(this),updateRow:this._updateRow.bind(this),cmd:a.cmd||'ListComment'});this.parent(a)},_updateBoard:function(d){var e=this.options;if(e.reject)return d.set('html',e.reject);var f=e.post;var g='<form method="post" action="">'+'<div class="f-row cv-pan"><textarea name="Detail" class="cv-txt"></textarea></div>'+'<div class="f-row"><button type="submit" class="cv-btn f-def">\u53d1\u9001</button>'+'<button type="button" class="cv-btn cv-cancel" _btn="Cancel" style="display:none">\u53d6\u6d88</button>'+(e.stretch?'':'<a cmd="'+e.cmd+'" href="#">[\u5237\u65b0]</a>')+'</div>'+'<input name="Action" value="'+f.Action+'" type="hidden"/>'+'<input name="Account" value="'+f.Account+'" style="display:none"/>'+'<input name="Author" value="'+f.Author+'" style="display:none"/>'+'<input name="ContentId" value="" style="display:none"/>'+'<input name="OwnerId" value="" style="display:none"/>'+'<input name="ParentId" value="" style="display:none" />'+'<input name="Indent" value="" style="display:none" />'+'<input name="Hilite" value="" style="display:none" />'+'</form>';d.set('html',g);var h=this.form=d.getElement('form');var i=function(){var a=h['Detail'].value;if(a.length==0)return false;return true};var j=function(a,b){if(b<0)return h.warn('\u4e0d\u80fd\u63d0\u4ea4');var c=h.toData({CommentId:b,PublishDate:'\u521a\u624d'});h['Detail'].value='';this.appendRow(c)}.bind(this);new FormX(h,j,i)},_moveBoard:function(a,b){a.getElement('[_btn=Cancel]').setStyle('display',b?'':'none');a['ParentId'].value=b?b.get('_id'):'0';a['Indent'].value=b?b.get('_indent').toInt()+1:0;var c=this.options;var d=$(a['Detail']);d.placeholder=b?'\u56de\u590d'+b.get('_author')+':':(c.tip||c.caption)+':';if(b)d.focus()},_updateRow:function(a,b){var c=this.options;var d=c.removeable?3:2;var e=c.archived;var f=(c.userlink&&a.Account!='0'?'<a href="'+c.userlink+'" class="avatar ftl" style="background-image:url({Avatar})"></a>':'<div class="avatar ftl" style="background-image:url({Avatar})"></div>')+'<div class="cv-inn"><div class="lo">'+(!e&&a.Indent<d?'<span class="cv-lbt" _btn="Reply">\u56de\u590d</span>':'')+(!e&&c.removeable?'<span class="cv-lbt" _btn="Remove">\u5220\u9664</span>':'')+'<span class="cv-lbl">{PublishDate}</span>{Author}</div>'+'<div class="hot{Hilite}">{Detail}</div>'+'</div>';a=jo.html(a,{Avatar:Passport.avatar(a.Account),PublishDate:a.PublishDate.utc()});b.set({'_id':a['CommentId'],'_indent':a['Indent'],'_author':a['Author'],html:f.substitute(a)});b.setStyle('padding-left',a['Indent'].toInt()*20)},update:function(a,b,c){var d=c.Archived=='1';var e=this.options;e.removeable=c.Removeable;e.archived=d;this.board.display(!d);var f=this.form;if(f){f['ContentId'].value=c.ContentId;f['OwnerId'].value=c.OwnerId;f['Hilite'].value=c.Hilite};this.parent(a,b)}});
var Annotate=new Class({Implements:[Options],options:{shown:true},initialize:function(e){this.setOptions(e);e=this.options;var f=e.stickTo;delete e.stickTo;f.addEvent('click',function(a){if(e.adding||!e.shown)return;var b=a.target.tagName.toLowerCase();if(['a','button','input','select','textarea'].indexOf(b)>-1)return;a.preventDefault();var c=a.page;var d=f.getPosition();var p={x:c.x-d.x-9,y:c.y-d.y-18};this.appendNote(p)}.bind(this));var g=function(a){var b=a.target;if(!b.hasClass('an-note'))b=b.getParent('.an-note');if(!b||b.hasClass('an-adding'))return null;a.stop();return b};this.container=new Element('div.annotate').inject(f,'before').display(e.shown).addEvents({'click':function(a){var b=g(a);if(b)this._showNote(b)}.bind(this),'contextmenu':function(a){var b=g(a);if(b&&e.doRemove(b))b.dispose()}.bind(this)})},_createNote:function(a){var b='<span class="an-flag wi">'+Wicon.flag+'</span>';return new Element('div.an-note',{html:b}).inject(this.container).setPosition(a).setOpacity(0.85)},_updateNote:function(b,s){new Element('span.an-text',{html:s.html(),'style':'display:none'}).inject(b);var c=this.options;var d=this.container;b.makeDraggable({onComplete:function(a){c.doMove(a,a.getPosition(d))}})},_showNote:function(a){a.getElement('.an-text').displayToggle()},show:function(a){this.options.shown=a;this.container.display(a)},expand:function(){this.container.getElements('.an-note').each(function(a){this._showNote(a)},this)},clear:function(){var a=this.options;if(a.adding&&this.editor)this.editor.destroy();a.adding=false;this.container.empty()},appendNote:function(a){var b=this.options;b.adding=true;var c=this._createNote(a).addClass('an-adding');var d='<textarea class="an-edit" placeholder="\u5728\u8fd9\u91cc\u6dfb\u52a0\u6279\u6ce8"></textarea>';var e=this.editor=new StickDlg({stickTo:c,html:d,ok:function(){var s=e.dlg.getElement('textarea').value.replace(/\n/g,'').substr(0,50);if(s.length==0)return false;this._updateNote(c.removeClass('an-adding').addClass('an-new'),s);b.adding=false;b.doAppend(c,c.getPosition(this.container),s);return true}.bind(this),cancel:function(){c.dispose();b.adding=false;return true}})},update:function(c){this.clear();c.each(function(a){var b=this._createNote(a);this._updateNote(b,this.options.doUpdate(b,a))},this)}});
var BandX=new Class({stage:{},last:'',actived:'',idx:0,get:function(a){if(!a)return null;var b=this.stage;var c=b[a];if(!c)c=b[a]={_idx:this.idx++};return c},show:function(a){var b=this.actived;if(a==b)return false;var c=this.stage;var d=c[b]||{_idx:-1};var e=c[a];BandX.slide(e.widget,d.widget,e._idx>d._idx);this.last=b;this.actived=a;return true}});(function(){var d=function(b,c){if(!b)return;b.each(function(a){a.display(c)})};var e=function(){this.display(this.getStyle('animation-name').indexOf('From')>-1);this.setStyle('animation-name','')};var f=function(a,b){if(!a)return;if(!a.retrieve('_slideEnd')){a.store('_slideEnd',true);a.addEventListener('animationend',e);a.setStyles({'animation-duration':'.25s','animation-fill-mode':'both'})};a.display(true).setStyle('animation-name',b)};BandX.slide=function(a,b,c){if(typeOf(a)=='array'){d(b,false);d(a,true)}else{if(!b||!Browser.animation){a.display(true);if(b)b.display(false)}else{f(a,c?'moveFromRight':'moveFromLeft');f(b,c?'moveToLeft':'moveToRight')}}}})();
var SlideX=new Class({initialize:function(a,b,c){this.current=-1;this.pages=[];this.btns=[];this._pages=$(a);this._btns=$(b);this._pages.getElements('.sx-page').each(this.add,this);if(!c)c={};this.interval=c.interval;this.walk(0);this.play()},add:function(a){var b=this.pages.length+1;this.pages.push(a.display(false).inject(this._pages));if(this._btns)this.btns.push(new Element('span.sx-btn',{html:b}).addEvent('click',this.jump.pass([b-1],this)).inject(this._btns))},remove:function(a){if(this.pages.length<=0)return;this.pages[a].dispose();this.btns.getLast().dispose()},walk:function(a){if(a==this.current)return;var b=this.current;this.current=a;var c=this.pages;SlideX.transition(c[a],c[b],'sx-in','sx-out');var d=this.btns;var e=d[b];var f=d[a];if(e)e.removeClass('active');if(f)f.addClass('active')},next:function(){this.walk(this.current<this.pages.length-1?this.current+1:0)},play:function(){if(this.interval)this._play=this.next.periodical(this.interval,this)},stop:function(){clearInterval(this._play)},jump:function(a){this.stop();this.walk(a);this.play()}});(function(){var e=function(a){a.set('class',a.retrieve('s_ori')).eliminate('s_ori').display(a.retrieve('s_kept'))};var f=function(a,b){if(!a)return;a.display(b)};var g=function(a,b,c){if(!a)return;if(a.retrieve('s_ori'))e(a);if(!a.retrieve('s_end')){a.store('s_end',true);a.addEventListener('animationend',function(){e(this)})};a.display(true).store('s_kept',b).store('s_ori',a.get('class')).addClass(c)};var h=Browser.animation?g:f;SlideX.transition=function(a,b,c,d){h(a,true,c);h(b,false,d)}})();
var Widget={toggle:function(a,b){var c=a.hasClass('exp');var d=a.getNext();if(b){a.toggleClass('exp');c=!c};if(d)d.display(c)},cascade:function(e,f,g){var h;var i;var j=function(){h=null;if(f)h=e.getElement('.active');i=e.getElements('h3');i.each(function(a,b){if(b==0)a.addClass('exp');Widget.toggle(a)})};var k=function(a){if(h!=a){if(h)h.removeClass('active');h=a.addClass('active')}};var l=function(b){var c=b.target;if(c.hasClass('nop'))return;if(c.hasClass('wi'))c=c.getParent('h3');if(!c)return;var d=c.tagName.toLowerCase();if(d=='h3'){Widget.toggle(c,true);if(g&&c.hasClass('exp')){i.each(function(a){if(a!=c&&a.hasClass('exp'))Widget.toggle(a,true)})}}else if(f&&(d=='a'||d=='span'))k(c)};j();e.cascadePrepare=j;if(f)e.cascadeSelect=k;e.addEvent('click',l)},gotop:function(c,d,e){c=$(c);d=$(d)||window;var f=new Element('div.wi.gtop',{html:Wicon['up']}).inject(c).setOpacity(0.6).display(false).addEvent('click',function(){d.scrollTo(0,0)});var g=function(){var y=d.getScroll().y;f.display(y>0);if(c!=d){var x=c.offsetLeft+c.offsetWidth-f.offsetWidth;f.setStyle('left',x)};if(Browser.ie6)f.setStyle('top',y+d.getSize().y-f.offsetHeight-20);if(e){var a=e.getSize().y,y2=d.getSize().y;var b=a-y2<y?y+y2-a:0;e.tween('top',b)}};if(Browser.ie6)d.attachEvent('onscroll',g);else d.addEvent('scroll',g)},qedit:function(b,c,d){b.hide();var e=d!=null?d:b.get('html');var f=new Element('input.qedit').set('value',e).inject(b,'before');f.focus();f.select();var g=function(){b.show();var a=f.value;if(a.length>0&&a!=e)c(a);f.dispose()};f.addEvents({'keydown':function(a){if(a.key=='esc'||a.key=='enter'){a.stop();if(a.key=='esc')f.value=e;f.blur()}},'blur':g})},wopen:function(c,w,h,d){if(!Widget.wopen_list)Widget.wopen_list={};var f=Widget.wopen_list;if(f[c])return;f[c]=true;var g=window.getSize();if(!w)w=g.x-80;if(!h)h=g.y-100;var i=new Element('div.winbox',{style:'width:'+w+'px; height:'+h+'px;'}).inject(document.body);var j=function(){delete f[c];i.destroy()};var k=new Element('div.wi.winbox-close[html='+Wicon['close']+']').inject(i).addEvent('click',j);i.makeDraggable();i.position({relativeTo:document.body,position:'center'});var l=new Element('iframe.winbox-frame',{src:c,frameborder:0}).inject(i);if(d){l.addEvent('load',function(){try{var a=l.contentWindow;var b=a.location.href;j();d(b)}catch(e){}})};return i},slideMenu:function(c,d){var e=$(document.body);var f=new Element('div.slide-mask[style=display:none]').inject(e);var g=new Element('div.slide-pad[style=display:none]').inject(e).adopt(d);var h=function(){g.hide();f.hide()};var i=function(){f.show();g.show()};c.addEvent('click',i);f.addEvent('click',h);g.addEvent('click',function(a){var b=a.target;if(b.get('cmd'))h()});e.addEvent('swipe',function(a){if(a.direction=='right')i();else h()})}};
var Owa={getUrl:function(a,b){var p='/op/embed.aspx?src='+encodeURIComponent(a);if(a.getExtension()=='xls')p='/x/_layouts/xlviewerinternal.aspx?ui=zh-CN&rs=zh-CN&access_token=1&access_token_ttl=0&WOPISrc='+encodeURIComponent('http://w.hnjs.org/oh/wopi/files/@/wFileId?wFileId='+a);p='http://w.hnjs.org'+p;return b?'<div><iframe src="'+p+'" frameborder="0" width="100%" height="520"></iframe></div><p>&nbsp;</p>':p}};Owa.Preview=new Class({initialize:function(e){if(Browser.ie&&Browser.version<8)return;var f,lnk1,lnk2,cap;var g=function(a){if(f)f.display(false);var b=a.target;if(b.tagName.toLowerCase()!='a'||b.hasClass('owa2'))return;var c=b.href;if(!c||c.indexOf('w.hnjs.org')>0||(c.indexOf('z.hnjs.org')<0&&c.indexOf('z.hersp.com')<0))return;if(!c.isOwa())return;if(!f){f=new Element('div.owa[style=padding:6px 10px; max-width:150px; border:2px solid #333; background:#fff; position:absolute; z-index:2000]').inject(document.body);lnk1=new Element('a.owa1[html=\u9884\u89c8][href=#][style=margin-right:6px; padding:2px 12px; color:#fff; background:#D83B01; display:inline-block;]').inject(f);lnk2=new Element('a.owa2[html=\u4e0b\u8f7d][href=#][style=padding:2px 12px; color:#fff; background:#008A00; display:inline-block;]').inject(f);cap=new Element('div[style=font-size:12px;]').inject(f)};a.stop();var d=a.page;lnk1.href='http://w.hnjs.org/op/view.aspx?src='+encodeURIComponent(c);lnk2.href=c;cap.set('html',b.get('html')||b.get('title'));f.display(true).setStyles({'left':d.x-16,'top':d.y+6})};$(document).addEvent('click',g)}});

var Wicon={apps:'&#xe601;',menu:'&#xe602;',more:'&#xe603;',prev:'&#xe610;',next:'&#xe611;',back:'&#xe612;',forward:'&#xe613;',search:'&#xe614;',plus:'&#xe615;',print:'&#xe619;',close:'&#xe620;',collapse:'&#xe621;',expand:'&#xe622;',up:'&#xe623;',drop:'&#xe624;',find:'&#xe625;',left:'&#xe626;',right:'&#xe627;',edit:'&#xe630;',save:'&#xe631;',flight:'&#xe632;',remove:'&#xe633;',pin:'&#xe634;',loc:'&#xe635;',flag:'&#xe636;',download:'&#xe637;',exit:'&#xe638;',user:'&#xe639;',image:'&#xe640;',weixin:'&#xe650;'};var Pilot={path:'/lib',load:function(c,d){var e=function(){var a=c[0];c.shift();var b={onload:c.length>0?e:d};if(a.indexOf('.js')<0)a=Pilot.path+a+'.js';Asset.javascript(a,b)};var f=c?e:d;if(f)f()},start:function(a,b){var c=function(){if(window.App)new App(a)};this.load(b,c)}};var ParamStack={holder:{},set:function(a,b){var c=this.holder;if(!c[a])c[a]={};Object.append(c[a],b)},get:function(b,c,d,e){var f=this.holder;var g=f[b]||{};var h;if(typeOf(c)=='element'){h={};d.split(',').each(function(p){var n='_'+p;var a=c.get(n);if(a==null){if(p=='Page')a='1';else if(g[p])a=g[p];else a=''};h[p]=a})}else{h=c||g};if(e)Object.append(h,e);var i=JSON.encode(g)!=JSON.encode(h);if(i)f[b]=h;return{data:h,changed:i}}};var Passport={prefix:'',clear:function(){var b=Passport;b.clearing=true;var c=b.prefix;var d=c?App.host:App.domain;['CP','UID','UN','CA'].each(function(a){Cookie.dispose(c+a,{path:'/'+(a=='CA'?'admin':''),domain:d})});jo.reload();return true},load:function(a,b,c){var d=this.prefix;var e=d+'CP';Object.append(this,{CP:Cookie.read(e),UID:Cookie.read(d+'UID'),UN:Cookie.read(d+'UN')});var f=this.ready=!!this.CP;if(!f&&a)location.replace(b||App.wai);if(f&&!c&&!this.watched){var g=function(){if(!Passport.clearing&&Passport.CP!=Cookie.read(e))alert('\u767b\u5f55\u8eab\u4efd\u5df2\u6539\u53d8\uff0c\u8bf7\u5237\u65b0\u9875\u9762\u3002')};this.watched=true;window.addEvent('focus',g)};return a?f:true},avatar:function(a,b,c){if(!a)a=this.UID;if(!a)return'';if(typeOf(a)!='string')a=a.toString();var p=a.length>3?a.substr(0,a.length-3):'0';var d=App.hostz+'/dat/avatar/'+p+'/'+a+(c||'')+'.jpg';if(b)d+='?t='+Number.random(1,999);return d}};var RequestX=new Class({initialize:function(){var e=Array.link(arguments,{url:Type.isString,data:Type.isObject,callback:Type.isFunction});var f=RequestX.provider(e.url,e.data.Action);var g=function(){RequestX.indicate(true)};var h=function(){RequestX.indicate(false)};var i=function(a){alert('\u7f51\u7edc\u9519\u8bef\u6216\u670d\u52a1\u5668\u7ef4\u62a4\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002')};var j=function(a,b){var c=new XmlData(b);var d=e.callback;if(d)d(c,c.state,b,a)};Object.append(e,{url:f,onSuccess:j,onFailure:i,onRequest:g,onComplete:h});var k=new Request(e);if(f.indexOf(':')>-1)k.headers={};k.send()}});RequestX.provider=function(a,b){if(!a)a=RequestX.url;if(a.indexOf('/')<0)a='/admin/'+a;if(RequestX.debug)a+='?_d='+b;return a};RequestX.indicate=function(a){var b=RequestX.pin;if(!b||!b.getParent('body'))b=RequestX.pin=new Element('div.'+RequestX.loading).inject(document.body);b[a?'show':'hide']()};
var MCE={init:function(a){var b=tinymce.majorVersion;if(b!='3')a='#'+a;MCE['init'+b](a)},set:function(a,b){try{var c=tinymce.get(a);c.setContent(b);c.getWin().scrollTo(0,0)}catch(e){$(a).set('html',b)}},get:function(a){tinymce.triggerSave();return tinymce.get(a).getContent()},init4:function(a){tinymce.init({selector:a,content_css:App.mceCss,menubar:false,language:'zh_CN',plugins:'contextmenu code charmap textcolor advlist lists autolink anchor link image media table hr',toolbar1:'cut copy paste | undo redo | insert table | unlink removeformat | strikethrough superscript subscript blockquote | bullist numlist | outdent indent | code',toolbar2:'formatselect fontselect fontsizeselect bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify',font_formats:"\u9ed8\u8ba4=Microsoft YaHei;\u5b8b\u4f53=verdana,\u5b8b\u4f53;\u9ed1\u4f53=\u9ed1\u4f53;\u6977\u4f53=\u6977\u4f53,\u6977\u4f53_GB2312;\u4eff\u5b8b=\u4eff\u5b8b,\u4eff\u5b8b_GB2312;\u96b6\u4e66=\u96b6\u4e66;Arial=arial,helvetica,sans-serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Times New Roman=times new roman,times",block_formats:'\u6bb5\u843d=p;\u533a\u5757=div;\u6807\u98981=h1;\u6807\u98982=h2;\u6807\u98983=h3',resize:false,relative_urls:false,remove_script_host:false})},init3:function(a){tinymce.init({elements:a||'',content_css:App.mceCss,mode:'exact',theme:'advanced',language:'zh-cn',plugins:"safari,table,advimage,advlist,advlink,media,contextmenu,visualchars,inlinepopups",theme_advanced_font_sizes:"\u4e09\u53f7=16pt,\u5c0f\u4e09=15pt,\u56db\u53f7=14pt,\u5c0f\u56db=12pt,\u4e94\u53f7=14px,\u5c0f\u4e94=9pt",theme_advanced_buttons1:"cut,copy,paste,|,undo,redo,|,link,unlink,anchor,image,media,hr,charmap,|,bullist,numlist,|,outdent,indent,|,code",theme_advanced_buttons2:"formatselect,fontselect,fontsizeselect,bold,italic,underline,|,forecolor,backcolor,|,justifyleft,justifycenter,justifyright,justifyful",theme_advanced_buttons3:"tablecontrols,|,strikethrough,sub,sup,blockquote,|,cleanup,removeformat",theme_advanced_fonts:"\u5b8b\u4f53=verdana,\u5b8b\u4f53;\u9ed1\u4f53=\u9ed1\u4f53;\u6977\u4f53=\u6977\u4f53,\u6977\u4f53_GB2312;\u4eff\u5b8b=\u4eff\u5b8b,\u4eff\u5b8b_GB2312;\u96b6\u4e66=\u96b6\u4e66;Arial=arial,helvetica,sans-serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Times New Roman=times new roman,times",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_blockformats:'p,div,h1,h2,h3',theme_advanced_resizing:false,relative_urls:false,remove_script_host:false,convert_urls:true})},fullHeight:function(f){var g=$(f);var h=g.getParent();var i;var j=tinymce.majorVersion=='3'?15:110;var k=0;var l=function(){var a=h.getSize();if(a.y==0)return;var b=a.y-i;if(k==b)return;k=b;var c=tinymce.get(f);var d=b-j;var e=a.x;if(c&&c.theme)c.theme.resizeTo(e,d);else g.setStyle('height',d)};if(!g.retrieve('dbs:adjust')){i=g.offsetTop;g.store('dbs:adjust',true);window.addEvent('resize',l)};l()}};
var jo={so:function(a){var s='';for(var p in a)s+=p+': '+a[p]+'\n';alert(s)},see:function(a,b){var s=JSON.encode(a);if(!b)alert(s);return s},html:function(a,b){var r=Object.append({},b);for(var p in a){if(!r.hasOwnProperty(p))r[p]=typeOf(a[p])=='string'?a[p].html():a[p]}return r},reload:function(){if(App.weixin)location.replace(location.href.query('wxt',Number.random(0,99999)));else location.reload()},injectStyle:function(s){var a=document.createElement('style');a.type='text/css';if(a.styleSheet)a.styleSheet.cssText=s;else a.appendChild(document.createTextNode(s));document.head.appendChild(a)},showBulletin:function(a){var b=a.msg;var c=a.id;if(!b||(c&&Cookie.read(c)))return;var d=new Element('div.bull',{html:b}).inject(document.body);new Element('button.bull-btn[type=button][html=\u5173\u95ed]').inject(d,'top').addEvent('click',function(){if(c)Cookie.write(c,'1',{duration:1});d.dispose()})},updateBkimg:function(a,b,c){Asset.image(b,{onload:function(){$(a).setStyle('background-image','url('+b+')');if(c)c(a)}})},setBingPic:function(b,c){var d=new Date();var f='http://z.hnjs.org/admin/bingo.aspx?d='+d.getFullYear()+(d.getMonth()+1)+d.getDate();var g='http://cn.bing.com';Asset.javascript(f,{onload:function(){try{var a=bing_pic.images[0];a.src=g+a.url;if(b)b.setStyle('background-image','url('+a.src+')');if(c)c(a)}catch(e){}}})},getFieldText:function(d,e,f,g,h){var j=d!='option';var k=!j?'<option value="{value}" {def}>{html}</option>':('<label><input name="{name}" value="{value}" {def} type="'+d+'" class="f-chk"/> {html}</label>');var m=!(g||g===0);var n=function(a,b,p){var c={name:e,value:h?b:a,html:h?a:b};if((p==0&&m)||a==g)c.def=j?'checked="cheked"':'selected="selected"';return k.substitute(c)};var o='';if(typeOf(f)=='array'){for(var i=0,l=f.length;i<l;i++)o+=n(f[i],f[i],i)}else{var q=f.__seq__;if(q){for(var i=0,l=q.length;i<l;i++)o+=n(q[i],f[q[i]],i)}else{var r=0;for(var p in f)o+=n(p,f[p],r++)}};return o},getViewSibling:function(a,b,c){var d=a.get('_dir')||'next';var e=b.findSibling(c,d);if(e=='0')a.tip('\u5df2\u7ecf\u662f'+(d=='next'?'\u6700\u540e\u4e00\u4e2a':'\u7b2c\u4e00\u4e2a'));return e},getTableRow:function(a,b,c,d){var e=b.selected();if(!e){a.tip('\u8bf7\u5148\u4ece\u8868\u683c\u4e2d\u9009\u62e9\u8bb0\u5f55');return false};if(!c)return true;var f=e[d||'getLast']().get('_data');var g=JSON.decode(unescape(f));return g},removeTableRow:function(a,b,c,d){var e=b.checked();if(e.length==0)return a.tip('\u8bf7\u5148\u9009\u62e9\u8981\u5220\u9664\u7684\u8bb0\u5f55');var f=new StickDlg({stickTo:a,html:d||'\u8981\u5220\u9664\u9009\u5b9a\u7684\u8bb0\u5f55\u5417\uff1f',ok:function(){b.remove(e);if(c)c(e);return true}})}};
var App=new Class({current:{},initCommand:function(a,b){return $(a||document.body).addEvent(b||'click',this.handleCommand.bind(this))},handleCommand:function(a){var b=a.target;var c=b.get('cmd');if(!c){b=b.getParent('*[cmd]');if(b)c=b.get('cmd')};if(c){if(b.get('_ss'))b.singleSelect();a.preventDefault();this.execCommand(b,c)}},execCommand:function(a,b){if(b.indexOf('Band')>0)this.openBand(b,a);else if(b.indexOf('Dlg')>0)this.openDialog(b,a);else{b=b.substr(0,1).toLowerCase()+b.substr(1);if(this[b])this[b](a);else alert(b)}},openBand:function(a,b){var c=this._bands;if(!c)c=this._bands=new BandX();var d=c.get(c.actived);if(d&&d.hide)d.hide(b);if(a=='LastBand'){a=c.last;if(!a)return};var e=c.get(a);if(!e.ready){this['init'+a](b,e,a);e.ready=true};if(e.prepare&&!e.prepare(b))return;if(this.updateBand)this.updateBand(b,e,a);c.show(a);if(e.update)e.update(b)},openDialog:function(a,b){var c=this._dlgs;if(!c)c=this._dlgs={};var d=c[a];if(!d){d=c[a]={};this['init'+a](b,d);d.hide=d.pane.hide};if(d.prepare&&!d.prepare(b))return;d.pane.show(b);if(d.update)d.update(b)},hideDialog:function(){var a=this._dlgs;if(!a)return;for(var p in a)a[p].hide()},initSwipeBands:function(b){var c=this._bands;var d=b.length,idx,cur;document.body.addEvent('swipe',function(a){if(cur!=c.actived){cur=c.actived;idx=b.indexOf(cur)};idx+=a.direction=='left'?1:-1;if(idx<0)idx=0;if(idx>=d)idx=d-1;cur=b[idx];this.openBand(cur)}.bind(this))},login:function(a){location.replace(App.wai)},logout:function(a){if(a.get('_mode'))return Passport.clear();var b=new StickDlg({stickTo:a,html:'\u786e\u5b9a\u8981\u9000\u51fa\u5417\uff1f',align:'right',ok:Passport.clear})}});(function(){var e=location.host.toLowerCase();var f=e.substr(e.indexOf('.'));var g=e.indexOf('dbs.dev')>0;var h=g&&location.href.query('dev');var i='http://z'+f;var j='http://x'+f;var k='http://c'+f;Object.append(App,{portable:Browser.portable,dbs:g,dev:h,host:e,domain:f,hostz:i,hostx:j,hostc:k,downIcon:j+'/ui/wss/i-down.png',mceCss:j+'/ui/wss/base_mce.css',wai:'http://localhost:8080/cerhy/login.jspx?returnUrl='+location.href,upload:i+'/admin/upload.aspx'});var l=navigator.userAgent.toLowerCase();App.weixin=/micromessenger/.test(l);var m=Browser.animation;RequestX.loading='loading'+(m?'':'2');FormX.posting='posting'+(m?'':'2');App.version=function(a,b){var c=b.get('App');var d=a==c.ver;if(!d)alert('\u7f51\u7ad9\u5df2\u7ecf\u5347\u7ea7\u3002\u003c\u0062\u0072\u002f\u003e\u8bf7\u6309\u201c\u0043\u0074\u0072\u006c\u002b\u0046\u0035\u201d\u6216\u201c\u0063\u006d\u0064\u002b\u0052\u201d\u5237\u65b0\u9875\u9762\u3002\u003c\u0062\u0072\u002f\u003e\u82e5\u4ecd\u7136\u770b\u5230\u6b64\u4fe1\u606f\uff0c\u8bf7\u6e05\u7a7a\u6d4f\u89c8\u5668\u7f13\u5b58\u518d\u6253\u5f00\u3002');return d};App.compatible=function(){var a=Browser.ie&&Browser.version<8;if(a)location.replace(App.hostx+'/ui/upgrade.htm');return!a};window.alert=PopupDlg.alert;App.start=function(a){if(!App.compatible())return;window.addEvent('domready',function(){new App()})}})();