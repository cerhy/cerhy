/* (c) dbs, ghljj.com. Distributed under MIT License */
/* plugin */
var NoobSlide=new Class({initialize:function(a){this.items=a.items;this.mode=a.mode||'horizontal';this.modes={horizontal:['left','width'],vertical:['top','height']};this.size=a.size||240;this.box=a.box.setStyle(this.modes[this.mode][1],(this.size*this.items.length)+'px');this.button_event=a.button_event||'click';this.handle_event=a.handle_event||'click';this.onWalk=a.onWalk||null;this.currentIndex=null;this.previousIndex=null;this.nextIndex=null;this.interval=a.interval||5000;this.autoPlay=a.autoPlay||false;this._play=null;this.handles=a.handles||null;if(this.handles)this.addHandleButtons(this.handles);this.buttons={previous:[],next:[],play:[],playback:[],stop:[],toggle:[]};if(a.addButtons){for(var b in a.addButtons){this.addActionButtons(b,typeOf(a.addButtons[b])=='elements'?a.addButtons[b]:[a.addButtons[b]])}}this.fx=new Fx.Tween(this.box,Object.append((a.fxOptions||{duration:500}),{property:this.modes[this.mode][0],link:'cancel'}));this.walk((a.startItem||0),true,true)},addHandleButtons:function(a){for(var i=0;i<a.length;i++){a[i].addEvent(this.handle_event,this.walk.bind(this,i,true,false))}},addActionButtons:function(a,b){for(var i=0;i<b.length;i++){switch(a){case'previous':b[i].addEvent(this.button_event,this.previous.bind(this,true));break;case'next':b[i].addEvent(this.button_event,this.next.bind(this,true));break;case'play':b[i].addEvent(this.button_event,this.play.bind(this,[this.interval,'next',false]));break;case'playback':b[i].addEvent(this.button_event,this.play.bind(this,[this.interval,'previous',false]));break;case'stop':b[i].addEvent(this.button_event,this.stop.bind(this));break;case'toggle':b[i].addEvent(this.button_event,this.toggle.bind(this,b[i]));break}this.buttons[a].push(b[i])}},previous:function(a){this.walk((this.currentIndex>0?this.currentIndex-1:this.items.length-1),a)},next:function(a){this.walk((this.currentIndex<this.items.length-1?this.currentIndex+1:0),a)},play:function(a,b,c){this.stop();if(!c){this[b](false)}this._play=this[b].periodical(a,this,[false])},stop:function(){clearInterval(this._play)},toggle:function(a){var b=this.autoPlay=a.hasClass('go');this[b?'next':'stop'](true);a.toggleClass('go')},walk:function(a,b,c){if(a!=this.currentIndex){this.currentIndex=a;this.previousIndex=this.currentIndex+(this.currentIndex>0?-1:this.items.length-1);this.nextIndex=this.currentIndex+(this.currentIndex<this.items.length-1?1:1-this.items.length);if(b){this.stop()}if(c){this.fx.cancel().set((this.size*-this.currentIndex)+'px')}else{this.fx.start(this.size*-this.currentIndex)}if(b&&this.autoPlay){this.play(this.interval,'next',true)}var d=this.items[this.currentIndex]||null;var e=this.handles&&this.handles[this.currentIndex]?this.handles[this.currentIndex]:null;if(this.onWalk){this.onWalk(d,e)}else{if(this.handles)this.handles.removeClass('active');if(e)e.addClass('active')}}}});

/* extend */
String.implement({query:function(a,b){var c=new RegExp('[/?&]'+a+'=([^&#]*)?');var d=this.match(c);if(b!=undefined){b=a+'='+b;return d==null?this+(this.indexOf('?')<0?'?':'&')+b:this.replace(c,d[0].substr(0,1)+b)}else return d!=null?d[1]:''},utc:function(a){if(this.indexOf('T')<0)return this;var d=this.replace('T',' ');switch(a){case'mdhn':return d.substr(5,11);case'ymdhn':return d.substr(0,16);case'ymd':return d.substr(0,10);case'md':return d.substr(5,5);default:var b=new Date(),dt1=this.utcDate(),dt2=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);var c=Math.floor((dt2-dt1)/86400000);switch(c){case 0:return'\u4eca\u5929 '+d.substr(11,5);case 1:return'\u6628\u5929 '+d.substr(11,5);case 2:return'\u524d\u5929 '+d.substr(11,5);default:return(dt2.getFullYear()-dt1.getFullYear())>0?d.substr(0,a=='s'?10:16):d.substr(5,11)}}},utcDate:function(){return new Date(this.substr(0,4),this.substr(5,2)-1,this.substr(8,2),this.substr(11,2),this.substr(14,2),this.substr(17,2))},html:function(){return this.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\x20\x20/g,'&nbsp; ').replace(/\t/g,'&nbsp; ').replace(/\"/g,'&quot;').replace(/\n/g,'<br>')},toHtml:function(){return/(<([^>]+)>)/ig.test(this)?this.wipeScript():this.replace(/\n/g,'<br>')},stripHtml:function(){return this.replace(/(<([^>]+)>)/ig,'').replace(/&nbsp;/ig,' ').replace(/&lt;/ig,'<').replace(/&gt;/ig,'>').replace(/&amp;/ig,'&')},padLeft:function(a,b){if(!b)b='0';var c='';for(var i=0,j=a-this.length;i<j;i++)c=c+b;return c+this},isImage:function(){var p=this.lastIndexOf('.');var a=this.substr(p);var b=['.jpg','.png','.gif'];return b.indexOf(a.toLowerCase())>-1},thousands:function(){return this.replace(/(\d{1,3})(?=(\d{3})+(?:$|\.))/g,'$1,')},round:function(a){var d=this.toFloat();return isFinite(d)&&d!=0?d.round(a):''},dbc2sbc:function(){return this.replace(/[\uff01-\uff5e]/g,function(a){return String.fromCharCode(a.charCodeAt(0)-65248)}).replace(/\u3000/g,' ')},wipeScript:function(){var e=function(s){return s.replace(/<(script)(.|\n)*\/\1>\s*/ig,'')};var f=function(s){return s.replace(/<[a-z][^>]*\s*on[a-z]+\s*=[^>]+/ig,function(a,b){return a.replace(/\s*on[a-z]+\s*=\s*("[^"]+"|'[^']+'|[^\s]+)\s*/ig,'')})};var g=function(s){return s.replace(/<[a-z][^>]*\s*(href|src)\s*=[^>]+/ig,function(c,d){c=c.replace(/&#(6[5-9]|[78][0-9]|9[0789]|1[01][0-9]|12[012]);?/g,function(a,b){return String.fromCharCode(b)});return c.replace(/\s*(href|src)\s*=\s*("\s*(javascript|vbscript):[^"]+"|'\s*(javascript|vbscript):[^']+'|(javascript|vbscript):[^\s]+)/ig,'')})};var h=function(s){return s.replace(/<[a-z][^>]*\s*style\s*=[^>]+/ig,function(c,d){c=c.replace(/&#(6[5-9]|[78][0-9]|9[0789]|1[01][0-9]|12[012]);?/g,function(a,b){return String.fromCharCode(b)});return c.replace(/\s*style\s*=\s*("[^"]+(expression)[^"]+"|'[^']+\2[^']+'|[^\s]+\2[^\s]+)\s*/ig,'')})};return e(f(g(this)))}});Array.implement({getIndex:function(a,b){for(var i=0,l=this.length;i<l;i++){if(a.call(b,this[i],i,this))return i};return-1},find:function(a,b){var c=this.getIndex(a,b);return c>=0?this[c]:null}});Date.implement({span:function(){var d=new Date();var a=d.getTime()-this.getTime();return a}});
Element.implement({triggerClick:function(){if(this.click)this.click();else{var a=document.createEvent("MouseEvents");a.initEvent("click",true,true);this.dispatchEvent(a)};return this},addHover:function(){if(Browser.ie6){var b=function(a){this[a.type=='mouseover'?'addClass':'removeClass']('hover')}.bind(this);this.addEvents({'mouseover':b,'mouseout':b})}return this},singleSelect:function(a){this.addClass('active').getSiblings(a).removeClass('active');return this},display:function(a){this.style.display=(a==false?'none':'');return this},visible:function(){return this.style.display!='none'},displayGroup:function(b){this.getElements('*[_group]').each(function(a){a.display(b[a.get('_group')])});return this},makeOptions:function(d,e,f){var g=this;var h=function(a,b,p){var c=document.createElement('OPTION');c.value=f?b:a;c.innerHTML=f?a:b;if((p==0&&!(e||e===0))||a==e){c.setAttribute('selected','selected');c.defaultSelected=true};g.appendChild(c)};var j=0;if(typeOf(d)=='array'){for(var i=0,l=d.length;i<l;i++)h(d[i],d[i],i)}else{var k=d.__seq__;if(k){for(var i=0,l=k.length;i<l;i++)h(k[i],d[k[i]],i)}else{for(var p in d)h(p,d[p],j++)}};return this},tabReady:function(c,d,e){if(!e)e='span';var f=function(a){a.singleSelect();c(a)};if(d>-1)f(this.getChildren(e)[d]);this.addClass('tab').addEvent('click',function(a){var b=a.target;if(b.tagName.toLowerCase()==e)f(b)});return this},pinReady:function(b,c){var d=this,c=$(c);b=$(b);if(!b)b=window;var e=Browser.ie6;var f,height,stickHeight;var g=d.getStyle('position');var h=function(){if(!d){b.removeEvent('scroll',h);return};if(!d.isVisible())return;var a=d.retrieve('dbs:_pined');if(!a){f=d.offsetTop;height=d.offsetHeight;stickHeight=c?c.offsetTop+c.offsetHeight:0};var y=b.getScroll().y;if(stickHeight>0&&y>stickHeight)y=0;if(y>f){if(!a){d.setStyles({position:'fixed',top:b.getPosition().y})};if(e)d.setStyles({position:'absolute',top:y});d.store('dbs:_pined',true).addClass('pinReady')}else{d.setStyles({position:g,top:f});d.store('dbs:_pined',false).removeClass('pinReady')}};if(e)b.attachEvent('onscroll',h);else b.addEvent('scroll',h);return this}});
(function(){var e,curDrop,activeClass='active';var f=function(){if(e){curDrop.removeClass(activeClass);e.hide();curDrop=null;e=null}};var g=function(a,b){if(a==curDrop)return;f();curDrop=a.addClass(activeClass);var c=curDrop.hasClass('alignRight')||curDrop.getStyle('float')=='right'?{relativeTo:curDrop,edge:'topRight',position:'bottomRight'}:{relativeTo:curDrop,position:'bottomLeft'};e=b.show().position(c)};var h=function(a,b,x,y){f();b.stickTo=a;curDrop=a.addClass(activeClass);e=b.show().setStyles({'left':x,'top':y})};var j=function(a){if(a.target!=e)f()};var k=function(){var a=document.body;for(var i=0,l=arguments.length;i<l;i++){var b=arguments[i],tag='dbs:_drop_'+b;if(!a.retrieve(tag)){a.addEvent(b,j);a.store(tag,true)}}};Element.implement({dropReady:function(b){var c=$(this.get('_drop'));this.addEvent(b||'click',function(a){a.stop();g(this,c)});k('click');return this},contextReady:function(b,c){var d=$(this.get('_drop'));this.addEvent(c||'contextmenu',function(a){if(b&&!b(a.target,d))return;a.stop();h(a.target,d,a.page.x,a.page.y)});k('click','contextmenu');return this}})})();
/* xml */(function(){if(window.XMLDocument&&Browser.Features.xpath){XMLDocument.prototype.selectNodes=Element.prototype.selectNodes=function(a){var b=new XPathEvaluator();var c=b.evaluate(a,this,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var d,nodes=[];while(d=c.iterateNext())nodes.push(d);return nodes};XMLDocument.prototype.selectSingleNode=Element.prototype.selectSingleNode=function(a){var r=this.selectNodes(a);return(r&&r.length>0)?r[0]:null}}})();
/* android2 */(function(){if(window.XMLDocument&&!Browser.Features.xpath){XMLDocument.prototype.selectNodes=Element.prototype.selectNodes=function(a){return this.getElementsByTagName(a.replace('//',''))};XMLDocument.prototype.selectSingleNode=Element.prototype.selectNodes=function(a){var b=this.selectNodes(a);return b&&b.length>0?b[0]:null}}})();
var Xml={getState:function(a){var b=a.selectSingleNode('//Result');return b?b.getAttribute('State'):0},getNode:function(a,b){return Xml.nodeToJson(a.selectSingleNode(b))},getNodes:function(a,b,c,d){return Xml.nodesToJsons(a.selectNodes(b),c,d)},nodeToJson:function(a){var b={};if(a)for(var i=0,len=a.attributes.length;i<len;i++)b[a.attributes[i].nodeName]=a.attributes[i].value;return b},nodesToJsons:function(a,b,c){var d=new Array;for(var i=0,len=a.length;i<len;i++)d[i]=this.nodeToJson(a[i]);return b?Xml.sortBy(d,b,c):d},sortBy:function(d,e,f){d.sort(function(l,r){var a=l[e],b=r[e];if(f=='1'||f=='-1'){a=parseInt(a);b=parseInt(b)}else if(f=='1.0'||f=='-1.0'){a=parseFloat(a);b=parseFloat(b)};var c=(f=='a'||f=='A')?a.trim().localeCompare(b.trim()):(a<b?-1:a>b?1:0);return(f=='-1'||f=='-1.0'||f=='A')?-c:c});return d},groupBy:function(b,c){var d={};b.each(function(a){var p=a[c];if(!d[p])d[p]=new Array;d[p].push(a)});return d}};
var DataList=new Class({Implements:[Events,Options],initialize:function(a){this.setOptions(a);this.kid=a.key;this.assign(a.data)},assign:function(a){this.ver=0;this.seq=a||[];this.modify('assign')},find:function(b){var c=this.seq.getIndex(function(a){return a[this.kid]==b},this);return c},get:function(a){var b=this.find(a);return b>-1?this.seq[b]:null},modify:function(a){this.ver++;this.fireEvent('changed',[a,this.seq,this.ver])},remove:function(a){var b=this.find(a);if(b>-1){this.seq.splice(b,1);this.modify('remove')}},update:function(a){for(var i=0,len=arguments.length;i<len;i++){var a=arguments[i];var b=this.find(a[this.kid]);if(b>-1)this.seq[b]=a;else this.seq.push(a)};this.modify(b>-1?'update':'append')}});
var BandGroup=new Class({Implements:[Options],lastActivedId:null,activedId:null,hash:{},initialize:function(a){this.setOptions(a);if(a.activedId)this.active(a.activedId)},append:function(a){var b=this.hash[a]=[];return b},display:function(b,c){b.each(function(a){a=$(a);if(!a)return;if(Browser.ie){if(!c&&a.visible())a.store('dbs:_scrollTop',a.scrollTop);a.display(c);if(c)a.scrollTop=a.retrieve('dbs:_scrollTop')}else a.display(c)})},active:function(a){if(a==-1)a=this.lastActivedId;if(!a||a==this.activedId)return;var b=this.options.changeGroup;var c=this.hash[a];if(!c){c=this.append(a);b('init',a,c)};for(var p in this.hash){if(p!=a)this.display(this.hash[p],false)};this.display(c,true);var d=this.lastActivedId=this.activedId;this.activedId=a;if(d)b('deactive',d,this.hash[d]);b('update',a,c)}});
var SheetGroup=new Class({Implements:[Options],lastActived:null,lastActivedId:null,activedSheet:null,activedId:null,initialize:function(a){this.setOptions(a);this.pane=$(a.id)||new Element('div.sheets');if($(a.parent))$(a.parent).adopt(this.pane);if(a.activedId)this.active(a.activedId)},append:function(a){var b=new Element('div#'+a+'.sheet[style=display:none]').inject(this.pane);return b},remove:function(a){$(a).dispose();if(this.activedId==a)this.activedId=null},active:function(a){if(a==-1)a=this.lastActivedId;if(!a||a==this.activedId)return;var b=this.options.changeGroup;var c=$(a);if(!c){c=this.append(a);b('init',a,c)};var d=this.activedId;var e=this.activedSheet;if(e){e.display(false);b('deactive',d,e)};this.lastActivedId=d;this.lastActived=e;this.activedId=a;this.activedSheet=c;if(c)c.display();b('update',a,c)}});
var FormValid=new Class({Implements:[Options],Binds:['handleSubmit','handleReset'],options:{mode:'ajax',cssErr:'err',required:{type:"required",re:/[^.*]/,msg:"\u4e0d\u80fd\u4e3a\u7a7a"},alpha:{type:"alpha",re:/^[a-z ._-]+$/i,msg:"\u53ea\u5141\u8bb8\u5b57\u6bcd"},alphanum:{type:"alphanum",re:/^[a-z0-9 ._-]+$/i,msg:"\u53ea\u80fd\u662f\u5b57\u6bcd\u548c\u6570\u5b57"},integer:{type:"integer",re:/^[-+]?\d+$/,msg:"\u53ea\u80fd\u662f\u6574\u6570"},real:{type:"real",re:/^[-+]?\d*\.?\d+$/,msg:"\u53ea\u80fd\u662f\u6570\u5b57"},date:{type:"date",re:/^(?:(?!0000)[0-9]{4}([-/.]?)(?:(?:0?[1-9]|1[0-2])\1(?:0?[1-9]|1[0-9]|2[0-8])|(?:0?[13-9]|1[0-2])\1(?:29|30)|(?:0?[13578]|1[02])\1(?:31))|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)([-/.]?)0?2\2(?:29))$/,msg:"\u65e5\u671f\u683c\u5f0f\u4e3a\u5e74\u002d\u6708\u002d\u65e5"},email:{type:"email",re:/^[a-z0-9._%-]+@[a-z0-9.-]+\.[a-z]{2,4}$/i,msg:"\u90ae\u4ef6\u683c\u5f0f\u4e0d\u5bf9"},phone:{type:"phone",re:/^[\d\s ().-]+$/,msg:"\u7535\u8bdd\u683c\u5f0f\u4e0d\u5bf9"},uri:{type:"uri",re:/^(http|https|ftp)\:\/\/[a-z0-9\-\.]+\.[a-z]{2,3}(:[a-z0-9]*)?\/?([a-z0-9\-\._\?\,\'\/\\\+&amp;%\$#\=~])*$/i,msg:"\u7f51\u5740\u683c\u5f0f\u4e0d\u5bf9"},confirm:{type:"confirm",msg:"\u786e\u8ba4\u5185\u5bb9\u4e0d\u7b26"},idcode:{type:"idcode",re:/(^\d{15}$)|(^\d{17}([0-9]|X|x)$)/,msg:'\u8eab\u4efd\u8bc1\u683c\u5f0f\u4e0d\u5bf9'}},initialize:function(d,e){this.form=$(d);this.setOptions(e);this.fields=this.form.getElements("*[d-vc]");this.validations=[];this.fields.each(function(b){var c=b.get('d-vc').split(' ');c.each(function(a){if(this.options[a])this.register(b,this.options[a]);if(a.charAt(0)=='=')this.register(b,Object.append(this.options.confirm,{idField:a.substr(1)}))},this)},this);this.form.addEvents({"submit":this.handleSubmit,"reset":this.handleReset})},register:function(a,b){a=$(a);a.set('oriTitle',a.get('title'));this.validations.push([a,b]);a.addEvent("blur",function(){this.validate(a,b)}.bind(this))},isChildType:function(a){var b=a.type.toLowerCase();if((b=="radio")||(b=="checkbox"))return true;return false},validate:function(a,b){var c=b.type=='confirm'?this.form[b.idField].get('value')==a.get('value'):b.re.test(a.get('value'));this.hilight(a,b,!c);return c},validateChild:function(a,b){var c=this.form[a.get("name")];var d=0;var e=true;for(var i=0;i<c.length;i++){if(c[i].checked){d++;if(!b.re.test(c[i].get('value'))){e=false;break}}};if(d==0&&b.type=="required")e=false;this.hilight(a,b,!e);return e},hilight:function(a,b,c){a[c?'addClass':'removeClass']('err');a.set('title',c?b.msg||'':a.get('oriTitle')||'')},validateAll:function(){var b=true;this.validations.each(function(a){if(!this[this.isChildType(a[0])?'validateChild':'validate'](a[0],a[1]))b=false},this);return b},lock:function(b){this.form.locked=b;this.form.getElements('*[type=submit]').each(function(a){a.disabled=b;a.toggleClass('posting',b)})},handleSubmit:function(d){var e=this.validateAll();if(e&&this.options.checkout)e=this.options.checkout(this.form);if(!e){if(d)d.stop();return e};this.lock(true);if(this.options.mode!='ajax')return e;if(d)d.stop();if(!this.form.retrieve('send')){this.form.set('send',{url:this.options.url||this.form.get('action'),onComplete:function(){this.lock(false)}.bind(this),onFailure:this.options.failure||Function.from(false),onSuccess:function(a,b){var c=b?Xml.getState(b):0;if(this.options.success)this.options.success(b,c,a,this.form)}.bind(this)})};this.form.send()},handleReset:function(b){this.validations.each(function(a){this.hilight(a[0],a[1],false)},this)}});
var OverText=new Class({initialize:function(a){if(Browser.placeholderSupport)return;a=$(a);var b=a.get('placeholder');if(!b)return;var c=new Element('label',{'class':'placeholder',html:b}).inject(a,'before');if(!a.get('id'))a.set('id','input_'+String.uniqueID());c.set('for',a.get('id'));var d=function(){c.hide()};var e=function(){c[!a.get('value')?'show':'hide']()};a.addEvents({focus:d,blur:e,change:e})}});
var StickDlg=new Class({Implements:[Options],Binds:['reposition','close','destroy','closeQuery'],align:'left',initialize:function(a){this.setOptions(a);var b=this.stickTo=$(a.stickTo||document.body);if(b.retrieve('stickDlg'))return;b.store('stickDlg',true);this.align=b.get('_stick')||a.align;var c=$(a.parent)||b.getParent();var d=this.dlg=new Element('div.stickDlg').set('html','<em'+(this.align=='right'?' class="ra"':'')+'></em>'+a.html).inject(c);if(a.klass)d.addClass(a.klass);d.set('tween',{duration:200});if(a.ok){var e=new Element('div.d-btn').inject(this.dlg);if(!a.custom){new Element('button.btn1.d-pot.ok',{'type':'button','html':'\u786e\u5b9a'}).inject(e);new Element('button.d-pot.cancel',{'type':'button','html':'\u53d6\u6d88'}).inject(e)};d.getElements('.d-pot').addEvent('click',this.closeQuery)}else setTimeout(this.close,a.delay||2000);window.addEvent('resize',this.reposition);if(a.scroll){this.scrollEvent=true;window.addEvent('scroll',this.reposition)};this.reposition()},closeQuery:function(a){var b=this.options;var c=a.target;if(c.hasClass('ok')&&b.ok&&!b.ok())return;if(c.hasClass('cancel')&&b.cancel&&!b.cancel())return;this.close()},close:function(){this.dlg.fade('out').get('tween').chain(this.destroy)},destroy:function(){window.removeEvent('resize',this.reposition);if(this.scrollEvent)window.removeEvent('scroll',this.reposition);this.dlg.destroy();this.stickTo.eliminate('stickDlg');this.stickTo=null},reposition:function(){var a=this.align=='right';this.dlg.position({relativeTo:this.stickTo,position:this.stickTo==document.body?'topLeft':(a?'bottomRight':'bottomLeft'),edge:a?'topRight':'topLeft'})}});
var PopupDlg=new Class({Binds:['show','hide','close','destroy','closeQuery'],initialize:function(a){var b=this.dlg=new Element('div.popDlg',{'style':'visibility:hidden; width:'+a.width+'px',tween:{duration:300,onComplete:function(){this.dlg.hide()}.bind(this)}}).inject(document.body);this.expand=a.expand||false;var c=new Element('div.d-cap',{html:a.title}).inject(b);if(a.draggable!=false)b.makeDraggable({handle:c});new Element('div.d-inn',{'html':a.content}).inject(b).getElements('.done').addEvent('click',this.hide);if(a.dialog>0){var d=new Element('div.d-btn').inject(b);new Element('button.btn1[type=button][html=\u786e\u5b9a]',{events:{click:function(){this.closeQuery(a.ok)}.bind(this)}}).inject(d);if(a.dialog>1)new Element('button[type=button][html=\u53d6\u6d88]',{events:{click:this.close}}).inject(d)}},show:function(a){this.dlg.set('opacity',1).show();var b=this.dlg.getSize();var c=document.documentElement,dx=c.clientWidth,dy=c.clientHeight;if(!this.expand&&b.y>=dy){b.y=dy-150;this.dlg.getElement('.d-inn').setStyle('height',b.y)};b.left=(dx-b.x)/2;b.top=(dy-b.y)/2+c.getScroll().y;this.dlg.setStyles(b);var d=this.dlg.getElement('button');if(d)d.focus()},hide:function(){this.dlg.fade('out')},closeQuery:function(a){if(a&&!a())return;this.close()},close:function(){this.dlg.fade('out').get('tween').chain(this.destroy)},destroy:function(){this.dlg.destroy();delete this.dlg}});PopupDlg.alert=function(a,b){new PopupDlg({dialog:1,width:380,title:b||'\u4fe1\u606f',content:typeOf(a)=='string'?a.toHtml():a}).show()};PopupDlg.confirm=function(a,b,c){new PopupDlg({dialog:2,width:380,title:c||'\u786e\u8ba4',content:typeOf(a)=='string'?a.toHtml():a,ok:b}).show()};
var PageSpin=new Class({Implements:[Options,Events],options:{len:5,label:'\u9875\u6b21: {Page}/{PageCount}, \u5171 {RecCount} \u6761',prev:'\u4e0a\u9875',next:'\u4e0b\u9875',jump:'\u8f93\u5165\u9875\u7801\u540e\u6309\u56de\u8f66'},initialize:function(b){this.setOptions(b);delete this.options.range;var c=this.pane=($(b.id)||new Element('div.paging')).hide().addEvent('click',this._handleClick.bind(this));if($(b.parent))$(b.parent).adopt(c);var d=b.cmd;var e=function(a){return new Element('span',{cmd:d,html:a}).inject(c)};this.label=new Element('div').inject(c);this.spot=[];for(var i=0,l=this.options.len+5;i<l;i++){var f=i==0?this.options.prev:(i==1||i==l-3?'...':(i==l-2?this.options.next:''));var a=e(f);if(i==l-1)a.hide();this.spot.push(a)};this.jump=new Element('input',{title:this.options.jump}).inject(c).addEvent('keydown',this._jump.bind(this));if(b.range)this.update(b.range)},update:function(a){this.range=Object.append({},a);if(!a.PageCount)this.range.PageCount=Math.ceil(a.RecCount/a.PageSize);this.adjust(a.Page)},adjust:function(p){this.pane.display(this.range.PageCount>0);var c=this.range.Page;if(typeOf(c)=='string')c=c.toInt();this.label.set('html',this.options.label.substitute(this.range));this.jump.set('value',c);var d=Math.max(c-1,1),p2=Math.min(c+1,this.range.PageCount);var e=this.spot.length;this.spot[0].set('_ps',d);this.spot[e-2].set('_ps',p2);var f=Math.floor((p-1)/this.options.len);var g=this.options.len;this.spot.each(function(a,b){if(b<=0||b>=e-2)return;var n=f*g+(b-1);a.set('_ps',n);a.set('html',b==1||b==e-3?'...':n);a.setStyle('display',n<1||n>this.range.PageCount?'none':'');a[n==c?'addClass':'removeClass']('active')},this)},_jump:function(a){if(a.key=='enter'){a.stop();var p=this.jump.get('value').toInt();if(isNaN(p)||p==this.range.Page||p<1||p>this.range.PageCount){this.jump.set('value',this.range.Page);return};this.spot[this.spot.length-1].set('_ps',p).triggerClick()}},_handleClick:function(a){var b=$(a.target);if(b.tagName.toLowerCase()!='span')return;var c=this.spot.indexOf(b);if(c<0)return;var p=b.get('_ps');if(c==1||c==this.spot.length-3){a.stop();this.adjust(p)}else{this.range.Page=p;b.set('page',p);this.adjust(p);if(!this.options.cmd){a.stop();this.fireEvent('changed',[p,b])}}}});
var TableView=new Class({Implements:[Options],initialize:function(a){this.setOptions(a);var b='',r2='',header=a.header;for(var p in header){if(header[p]){b+='<col style="'+header[p]+'"/>';r2+='<td>'+p+'</td>'}};var c='<colgroup><col style="width:38px"/>'+b+'</colgroup><thead><td class="holders">#</td>'+r2+'</thead><tbody></tbody>';this.table=new Element('table',{'class':'tableView',html:c}).inject(a.parent).addEvent('click',this._handleClick.bindWithEvent(this));this.tbody=this.table.getElement('tbody')},_handleClick:function(a){var b=a.target;var c=this.options.singleSelect;if(b.hasClass('holder')){if(c)return;b.toggleClass('on');this.selectRow(b.getParent('tr').toggleClass('selected'))}else if(b.hasClass('holders')){if(c)return;b.toggleClass('on');this.table.getElements('.holder')[b.hasClass('on')?'addClass':'removeClass']('on');this.tbody.getElements('tr')[b.hasClass('on')?'addClass':'removeClass']('selected');this.selectRow(this.tbody.getFirst())}else{if(b.tagName.toLowerCase()!='tr')b=b.getParent('tr');if(!b||b==this.lastRow)return;if(!b.getParent('tbody'))return;this.selectRow(b)}},show:function(a){this.table[a?'show':'hide']()},makeRow:function(a,b,c){return'<td'+(this.options.singleSelect?'':' class="holder"')+'>'+b+'</td>'+this.options.getRowHtml(a,b,c)},addRow:function(a,b){var c=new Element('tr',{'_id':a[this.options.id_name]});if(b){var d=b=='top'?this.tbody.firstChild:b.nextSibling;this.tbody.insertBefore(c,d)}else this.tbody.adopt(c);c.set('html',this.makeRow(a,'*',c));c.addHover();return c},updateRow:function(a,b){var c=this.findRow(a[this.options.id_name]);if(!c)this.addRow(a,b);else c.set('html',this.makeRow(a,'*',c))},selectRow:function(a){if(!a||a==this.lastRow)return;if(this.options.onSelected)this.options.onSelected(a,this.lastRow);if(this.lastRow)this.lastRow.removeClass('actived');this.lastRow=a.addClass('actived')},findRow:function(a){return this.tbody.getElement('tr[_id='+a+']')},findSibling:function(a,b){var c=this.findRow(a);if(!c)return-1;var d=c[b+'Sibling'];return d?d.get('_id'):0},removeRow:function(a){var b=this.findRow(a);if(b)b.dispose();if(b==this.lastRow)this.lastRow=null},remove:function(b){b.each(function(a){this.removeRow(a)},this);return b},update:function(c){var d=this.options;var e=d.gotop;if(e){var f=typeOf(e)=='element'?e:d.parent;f.scrollTop=0};this.lastRow=null;var g='',id_name=this.options.id_name;c.each(function(a,b){g+='<tr _id="'+a[id_name]+'">'+this.makeRow(a,b+1)+'</tr>'},this);this.tbody.empty().set('html',g).getElements('tr').addHover()},empty:function(){this.lastRow=null;this.tbody.empty()},selected:function(){return this.lastRow},checked:function(){var b=[];this.tbody.getElements('.holder.on').each(function(a){b.push(a.getParent().get('_id'))});if(b.length==0&&this.lastRow)b.push(this.lastRow.get('_id'));return b},count:function(){return this.tbody.childNodes.length}});var TableList=new Class({initialize:function(a){this.list=new TableView(a);if(a.spinParent)a.parent=a.spinParent;this.page=new PageSpin(a)},update:function(a,b){this.list.update(a);this.page.update(b)}});
var TopicView=new Class({Implements:[Options],options:{wrapClass:'topicView',rowClass:'row',wrapTag:'div',rowTag:'div'},initialize:function(c){this.setOptions(c);c=this.options;this.grid=new Element(c.wrapTag,{'class':c.wrapClass}).inject($(c.parent)).addEvent('click',function(a){var b=a.target;if(b.get('cmd')||b.getParent('.row > [cmd]'))this.selectRow(b.hasClass('row')?b:b.getParent('.row'))}.bind(this))},addRow:function(a,b){var c=this.options;var d=new Element(c.rowTag,{'class':c.rowClass,'_id':a[c.id_name]});return d.set('html',c.getRowHtml(a,d)).inject(this.grid,b)},updateRow:function(a,b){var c=this.findRow(a[this.options.id_name]);if(!c)this.addRow(a,b);else c.set('html',this.options.getRowHtml(a,c))},selectRow:function(a){a.singleSelect();if(this.options.changeRow)this.options.changeRow(a)},findRow:function(a){return this.grid.getElement('*[_id='+a+']')},findSibling:function(a,b){var c=this.findRow(a);if(!c)return-1;var d=b=='next'?'getNext':'getPrevious';var e=c[d]('[_id]');while(e&&e.get('_id')==a)e=e[d]('[_id]');if(e)this.selectRow(e);return e?e.get('_id'):0},removeRow:function(a){var b=this.findRow(a);if(b)b.dispose()},update:function(a,b){var c=this.options;var d=c.gotop;if(d){var e=typeOf(d)=='element'?d:c.parent;e.scrollTop=0};this.grid.empty();if(!a||a.length==0)this.grid.set('html',b);else this.append(a)},append:function(b){b.each(function(a){this.addRow(a)},this)},count:function(){return this.grid.getElements('[_id]').length}});var TopicList=new Class({initialize:function(a){this.list=new TopicView(a);if(a.spinParent)a.parent=a.spinParent;this.page=new PageSpin(a)},update:function(a,b,c){this.list.update(a,c);this.page.update(b)}});
var CommentView=new Class({Implements:[Options,Events],options:{pid_name:'ParentId'},initialize:function(a){this.setOptions(a);var b=this.pane=$(a.parent).addEvent('click',this.handleClick.bind(this));if(a.caption)new Element('h3.commentCap',{html:a.caption}).inject(b);this.grid=new Element('div.commentView').inject(b);this.spin=new PageSpin(a);this.board=new Element('div.commentBoard').inject(b);this.options.initBoard(this.board)},addRow:function(a,b){var c=new Element('div',{'class':'row','_id':a[this.options.id_name],html:this.options.getRowHtml(a)});if(b){var d=b=='top'?this.grid.firstChild:b.nextSibling;this.grid.insertBefore(c,d);c.highlight()}else this.grid.adopt(c)},appendRow:function(a){if(!this.row)this.grid.scrollIntoView(true);this.addRow(a,this.row||'top');this.moveBoard()},findRow:function(a){return this.grid.getElement('.row[_id='+a+']')},removeRow:function(a){this.moveBoard();var b=this.findRow(a);if(b)b.dispose()},moveBoard:function(a){this.row=a;this.board.getElement('.cancel').setStyle('display',a?'':'none');if(a){a.highlight().getElement('.inner').adopt(this.board);this.board.scrollIntoView(false)}else this.pane.adopt(this.board);var b=this.board.getElement('input[name='+this.options.pid_name+']');if(b)b.value=a?a.get('_id'):'0';this.fireEvent('moveBoard',a)},handleClick:function(a){var b=a.target;var c=b.getAttribute('cmd');if(c=='Reply'){a.stop();this.moveBoard($(b).hasClass('cancel')?null:b.getParent('.row'))};if(c=='Remove'){a.stop();var d=b.get('_id');var e=new StickDlg({stickTo:b,html:'\u8981\u5220\u9664\u8fd9\u6761\u8bb0\u5f55\u5417\uff1f',ok:function(){e.destroy();this.removeRow(d);if(this.options.remove)this.options.remove(d);return false}.bind(this)})}},update:function(b,c,d){this.empty();if(!this.options.lazyShow)this.show(true);b.each(function(a){this.addRow(a)},this);this.spin.update(c);if(d){var e=this.board;for(var p in d){var f=e.getElement('[name='+p+']');if(f)f.set('value',d[p])}}},show:function(a){this.pane.display(a)},scrollIntoView:function(){this.pane.scrollIntoView(true)},empty:function(){this.moveBoard();this.spin.update({RecCount:0,PageSize:50,Page:1});return this.grid.empty()},getIndent:function(){if(this.row){var a=this.row.getElement('[_indent]');if(a)return a.get('_indent').toInt()+1}return 0}});
var Annotate=new Class({Implements:[Options],initialize:function(e){this.setOptions(e,{expand:false,shown:true,enabled:false});e=this.options;this.container=new Element('div.annotate').inject(e.aim,'before');var f=function(a){var b=a.target;if(!b.hasClass('d-flag')||b.hasClass('d-add'))return null;a.stop();return b};this.container.addEvents({'click':function(a){var b=f(a);if(b)this.showNote(b)}.bind(this),'contextmenu':function(a){var b=f(a);if(!b)return;e.removeNote(b)}.bind(this)});var g=e.aim;g.addEvent('click',function(a){if(e.adding||!e.shown||!e.enabled)return;var b=a.target.tagName.toLowerCase();if(['a','img','button','input','select','textarea'].indexOf(b)>-1)return;a.stop();var c=a.page;var d=g.getPosition();var p={x:c.x-d.x-9,y:c.y-d.y-18};this.createNote(p)}.bind(this))},showNote:function(a){a.toggleClass('d-exp')},enable:function(a){this.options.enabled=a},expand:function(){var b=this.options;b.expand=!b.expand;var c=b.expand?'addClass':'removeClass';this.container.getElements('.d-flag').each(function(a){if(!a.hasClass('d-add'))a[c]('d-exp')})},show:function(a){var b=this.options;b.shown=a?a:!b.shown;this.container.display(b.shown)},clear:function(){var a=this.options;if(a.adding&&this.stick)this.stick.destroy();Object.append(a,{adding:false,shown:true,expand:false});this.container.empty()},addFlag:function(a){return new Element('div.d-flag').inject(this.container).setPosition(a).setOpacity(0.85)},updateNote:function(b,c){var d=this.options;var e=new Element('div.d-note').inject(b);d.updateNote(b,e,c);var f=this.container;b.makeDraggable({onComplete:function(a){d.moveNote(a,a.getPosition(f))}})},update:function(b){this.clear();this.show(true);b.each(function(a){this.updateNote(this.addFlag(a),a)},this)},createNote:function(a){var b=this.options;b.adding=true;var c=this.addFlag(a).addClass('d-add');var d='<textarea style="width:151px; height:50px; border-color: #fff;"></textarea>';var e=this.stick=new StickDlg({stickTo:c,html:d,ok:function(){var s=e.dlg.getElement('textarea').value;if(s.length==0)return false;c.removeClass('d-add');b.createNote(c,c.getPosition(this.container),s.substr(0,50));b.adding=false;return true}.bind(this),cancel:function(){c.dispose();b.adding=false;return true}})}});
var UploadForm=new Class({Implements:[Events,Options],options:{mode:'feedByUrl',allow:'file',imageExts:['jpg','gif','png'],fileExts:['jpg','gif','png','rar','zip','pdf','doc','ppt','xls','docx','pptx','xlsx'],imageMsg:'\u56fe\u7247',fileMsg:'\u56fe\u7247\u3001\u6587\u6863\u548c\u538b\u7f29\u5305',limit:4},initialize:function(a){this.setOptions(a);this[!!window.FormData&&a.morden?'initMorden':'initTradition']()},initTradition:function(){var i=this.options;var j=String.uniqueID();var k=i.allow;var l=i[k+'Exts'];var m=i[k+'Msg'];var n=i.mode;var o=i.limit;var p='<iframe id="{id}-iframe" name="{id}-iframe" style="display:none" src="about:blank"></iframe>'+'<form id="{id}-form" action="{action}" target="{id}-iframe" method="post" enctype="multipart/form-data">'+'<div class="pmt"></div>'+'<div class="step1"><input name="f0" type="file" size="1"/><button class="pick" type="button">\u9009\u62e9\u6587\u4ef6</button><button type="submit">\u4e0a\u4f20</button></div>'+'<div class="step2" style="display:none;"><button type="reset" class="posting">\u53d6\u6d88\u4e0a\u4f20</button></div>'+'</form>';i.pane=new Element('div.upload').inject(i.parent).set('html',p.substitute({id:j,action:i.action}));var q=$(j+'-form');var r=$(j+'-iframe');var t=q.getElement('.step1');var u=q.getElement('.step2');var v=q.getElement('input[type=file]').setOpacity(0);var w=q.getElement('.pmt');var x;var y=function(a){w.set('html','&nbsp;');t.display(a==1);u.display(a==2)};r.addEvent('load',function(){var a=r.contentWindow;var b=a.location;if(b.href=='about:blank')return;try{v.value=''}catch(e){};q.reset();var c=a.document;var d=Function.attempt(function(){return c.body.innerHTML})||'';var f=Function.attempt(function(){return c.location.href})||'';var g=n=='feedByUrl'?f:d;var h=decodeURIComponent(g.query('url'));if(h.length>0)this.success(h,x,g);b.href='about:blank';y(1)}.bind(this));v.addEvent('change',function(){var a=v.value,s=a.substring(a.lastIndexOf('\\')+1);w.set('html',s)});q.addEvents({'submit':function(a){var b=v.value.toLowerCase();var c=b.substr(b.lastIndexOf('.')+1);if(l.indexOf(c)<0){var d=m+'\uff0c\u4e0d\u80fd\u8d85\u8fc7'+o+'M';new StickDlg({stickTo:q,html:d});a.stop();return false};x=b.substring(b.lastIndexOf('\\')+1,b.lastIndexOf('.'));y(2)},'reset':function(a){y(1)}})},initMorden:function(j){var j=this.options;var k=j[j.allow+'Exts'];var l='\u62d6\u52a8'+j[j.allow+'Msg']+'\u5230\u8fd9\u91cc\u4e0a\u4f20';var m=j.limit*1048576;var n=j.action.query('XHR','1');j.pane=new Element('div.upload').inject(j.parent);var o=new Element('div.pmt',{html:l}).inject(j.pane);var p=new Element('span.step1',{html:'<input type="file" multiple size="1"/><button class="pick" type="button">\u9009\u62e9\u6587\u4ef6</button>'}).inject(j.pane);var q=p.getElement('input[type=file]').setOpacity(0).addEvent('change',function(a){w(this.files)});var r=function(a,b){var c=a.substr(a.lastIndexOf('.')+1).toLowerCase();if(k.indexOf(c)<0)return-1;if(b>=m)return-2;return 0};var t=function(a){var s=a+'B';for(var b=["K","M","G","T","P","E","Z","Y"],Multiple=0,Approx=a/1024;Approx>1;Approx/=1024,Multiple++){s=Approx.toFixed(1)+" "+b[Multiple]};return s};var u=this.success.bind(this);var v=function(f,e){var g=f.name,state=r(g,f.size);var h=t(f.size);var i=g+' ('+h+')';o.set('html',i);if(state!=0){new StickDlg({stickTo:o,html:state=='-1'?'\u4e0d\u5141\u8bb8\u4e0a\u4f20':'\u6587\u4ef6\u592a\u5927'});if(e)e.delay(1000);return};new XhrUpload(f,{url:n,withCredentials:true,complete:function(a,b,c,d){u(c,b.substr(0,b.lastIndexOf('.')));e.delay(1000)},onprogress:function(a){if(a.lengthComputable){var b=(a.loaded/a.total*100|0);o.set('html',b+'%: '+i)}},onload:function(){o.set('html','OK: '+i)}})};var w=function(a){var b=a.length,i=0;var c=function(){var f=a[i];if(!f)return;i++;v(f,c)};c()};var x=function(a){a.stopPropagation();a.preventDefault()};var y=function(a){x(a);w(a.dataTransfer.files)};var z=document.body;z.addEventListener('dragover',x,false);z.addEventListener('drop',y,false)},success:function(a,b){this.fireEvent('complete',[a,b])}});
var UploadPane=new Class({Extends:UploadForm,initialize:function(a){this.parent(a);var b=this.options.pane;this.clearBtn=new Element('button[html=\u6e05\u7f29\u7565\u56fe]').inject(b).display(false).addEvent('click',function(){new StickDlg({stickTo:this.clearBtn,html:'\u8981\u6e05\u9664\u7f29\u7565\u56fe\u5417\uff1f\u003c\u0062\u0072\u002f\u003e\u4e0a\u4f20\u7684\u6587\u4ef6\u4e0d\u4f1a\u88ab\u5220\u9664\u3002',ok:function(){this.thumbs.empty();this.clearBtn.display(false);return true}.bind(this)})}.bind(this));this.thumbs=new Element('div.thumbs').inject(b).addEvent('mousedown',this.clickThumb.bind(this))},success:function(a,b){this.addThumb(a,b)},selected:function(a){var b=a.tag<0?'<a href="{url}">{title}</a>':'<img src="{url}" alt="{title}" />';this.fireEvent('select',[b.substitute(a),a])},addThumb:function(a,b){if(!this.clearBtn.visible())this.clearBtn.display(true);var c=a.substr(a.lastIndexOf('.')).toLowerCase();var d=['.gif','.jpg','.png'].indexOf(c);var e={url:a,tag:d,title:b};new Element('img',{_url:e.url,_tag:e.tag,title:e.title,src:e.tag<0?this.options.downIcon:e.url}).inject(this.thumbs,'top');if(this.options.autoSelect)this.selected(e)},clickThumb:function(a){a.stop();var b=a.target;if(b.get('_url')){var c={url:b.get('_url'),tag:b.get('_tag'),title:b.title};this.selected(c)}}});var XhrUpload=new Class({initialize:function(b,c){var d=new XMLHttpRequest();d.open('POST',c.url,true);if(c.withCredentials)d.withCredentials=true;var e=function(){};d.onreadystatechange=function(){if(d.readyState!=4)return;d.onreadystatechange=e;var a=d.status>=200&&d.status<300;if(c.complete)c.complete(a,b.name,d.responseText,d.responseXML)};d.onload=c.onload||e;if(d.upload)d.upload.onprogress=c.onprogress||e;var f=new FormData();f.append('file',b);d.send(f)}});
var Cascade=new Class({initialize:function(c,d,e){this.pane=new Element('div.cascade').inject($(c)).set('html',d);if(!e)e={tag:'span'};if(!e.flat){var f=Object.append({opacity:false,duration:'50',alwaysHide:true,onActive:function(a,b){a.toggleClass('exp',true)},onBackground:function(a,b){a.toggleClass('exp',false)}},e);this.accordion=new Fx.Accordion(this.pane.getElements('h3'),this.pane.getElements('div'),f)};this.itemTag=e.tag||'span';this.pane.addEvent('click',function(a){this.singleSelect(a.target)}.bind(this))},singleSelect:function(b){if(b.hasClass('ns')||b.tagName.toLowerCase()!=this.itemTag)return;this.pane.getElements(this.itemTag).each(function(a){a.toggleClass('active',a==b)})},adjustHeight:function(a){if(a)a.setStyle('height','auto')},empty:function(){return this.pane.empty()},find:function(a){return this.pane.getElement('*[_id='+a+']')},select:function(a){var b=this.find(a);if(b)this.singleSelect(b)},remove:function(a){var b=this.find(a);if(b){var p=b.getParent();b.dispose();this.adjustHeight(p)}},update:function(a,b,c,d){if(!d)d=this.itemTag;var e=this.find(b),p;if(e){p=e.set('html',c).getParent()}else{p=this.pane.getElement('*[_pid='+a+']');if(p)e=new Element(d,{'_id':b,'html':c}).inject(p,'top')};this.adjustHeight(p);return e}});
var Section=new Class({initialize:function(b,c,d){var e=new Element('div.section').inject($(b));var f=this.caption=new Element('h3.exp').inject(e);var g=this.content=new Element('div.inner').inject(e);this.update(c,d);f.addEvent('click',function(a){f.toggleClass('exp');g.display(f.hasClass('exp'))})},update:function(a,b){if(a)this.caption.set('html',a);if(b)this.content.set('html',b)},display:function(a){this.caption.display(a);this.content.display(a);this.caption.toggleClass('exp',a)}});
var LoadPin=new Class({initialize:function(){this.pane=new Element('div',{'class':'loadPin'}).inject(document.body)},show:function(a,b){var c=this.pane.set('html',a).show();if(b){var d=c.getSize();var e=document.documentElement;d.left=(e.clientWidth-d.x)/2;d.top=(e.clientHeight-d.y)/2+e.scrollTop;c.setStyles({'left':d.left+'px','top':d.top+'px'})};return this},hide:function(){this.pane.hide();return this}});
var Gotop=new Class({initialize:function(a,b){a=$(a);var c=new Element('div.gtop').inject(a).setOpacity(0.6).display(false).addEvent('click',function(){window.scroll(0,0)});if(b)c.set('html','&and;');window.addEvent('scroll',function(){c.display(window.getScroll().y>0);var x=a.offsetLeft+a.offsetWidth-c.offsetWidth;c.setStyle('left',x);if(Browser.ie6)c.setStyle('top',window.getScroll().y+window.getSize().y-c.offsetHeight-20)})}});
var EntryEditor=new Class({initialize:function(b){var c=b.tar;if(!b.add)c.hide();var d=typeOf(b.value)!='undefined'?b.value:c.get('html')||'';var e=new Element('input').set('value',d).inject(c,b.add?'':'before');e.focus();e.select();var f=function(){if(!b.add)c.show();var a=e.value;if(a.length>0&&a!=d)b.accept(a);e.dispose()};e.addEvents({'keydown':function(a){if(a.key=='esc'||a.key=='enter'){a.stop();if(a.key=='esc')e.value=d;e.blur()}},'blur':f})}});
/* app */
var Hz={loadjs:function(c,d){c=typeof c==='string'?[c]:c.concat();var e=function(){if(c.length==0)return;var a=c[0];c.shift();var b={onload:c.length>0?e:d};if(a.indexOf('_gb')>-1)b['charset']='gb2312';Asset.javascript(a,b)};e()},htmlData:function(a,b){var r=Object.append({},a);for(var p in r){if(typeOf(r[p])=='string')r[p]=r[p].html()};return Object.append(r,b)},forin:function(a,b){var c=a.__seq__;var d=0;if(c){for(var i=0,l=c.length;i<l;i++)b(c[i],a[c[i]],i)}else{for(var p in a)b(p,a[p],d++)}},so:function(a){var s='';for(var p in a)s+=p+': '+a[p]+'\n';alert(s)},sx:function(a){var s=a.xml||new XMLSerializer().serializeToString(a);alert(s.html())},pilot:function(a,b){var c=location.host.indexOf('dbs.dev')>0,ts=location.href.query('dev');var d=typeOf(a)=='array'?a:[a];for(var i=0,len=d.length;i<len;i++){if(d[i].indexOf('.js')<0)d[i]='/lib/'+(c&&ts?'src/':'')+d[i]+'.js'+(c?'?stamp='+new Date():'')};var e=function(){if(App)new App(b)};Hz.loadjs(d,e)},gp:function(a,b,c){return typeOf(a)=='element'&&$(a).get(b)?$(a).get(b):c},request:function(a,b){var c='dbs:_requesting';var d='posting';if(b&&b.retrieve(c))return;if(b)b.store(c,true).addClass(d);var e=function(){if(b)b.eliminate(c).removeClass(d)};var f=function(){alert('\u7f51\u7edc\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5\u3002')};new Request(Object.append(a,{onFailure:f,onComplete:e})).send()}};(function(){var a=document.createElement('input');Browser.placeholderSupport=('placeholder'in a);delete a;this.$pilot=Hz.pilot;this.$gp=Hz.gp;this.$htmlData=Hz.htmlData;this.$forin=Hz.forin})();
var App=new Class({Implements:Options,current:{},handleClick:function(a){var b,el=a.target;var c=el.get('cmd');if(!c){b=$(el).getParent('*[cmd]');if(b)c=b.get('cmd')};if(!c){if(el.tagName.toLowerCase()=='a'&&el.href.indexOf('javascript')!=0&&!el.target)el.target='_blank';return true};a.preventDefault();this.transact(c,$(b||el))},transact:function(a,b){this._trigger=b;if(a.indexOf('Sheet')>0)this.sheets.active(a.indexOf('Last')==0?-1:a);else if(a.indexOf('Band')>0)this.bands.active(a.indexOf('Last')==0?-1:a);else if(a.indexOf('Dlg')>0)this.openDialog(a,b);else this.execCommand(a,b)},execCommand:function(a,b){a=a.substr(0,1).toLowerCase()+a.substr(1);if(this[a])this[a](b);else alert(a)},changeGroup:function(a,b,c){var d=a+b;if(this[d])this[d](c,this._trigger)},openDialog:function(a,b){if(!this._dlgs)this._dlgs={};var c=this._dlgs[a];if(!c){this._dlgs[a]=c={};this['init'+a](c,b);c.hide=c.pane.hide};if(c.check&&!c.check(b))return;if(c.pane)c.pane.show(b);if(c.update)c.update(b)},initOptions:function(a,b){var c=location.host.toLowerCase();var d=c.substr(c.indexOf('.'));var e='http://z'+d;this.setOptions({debug:c.indexOf('dbs.dev')>0,host:c,domain:d,sitez:e,upload:e+'/admin/upload.aspx'},a,b)},initPassport:function(a,b){this.passport=new Passport(b);var c=a&&!this.passport.CP;if(c)location.href=a;return!c},initHandle:function(a){return $(a||document.body).addEvent('click',this.handleClick.bind(this))},initSheets:function(a,b){this.sheets=new SheetGroup({id:$(a),activedId:b,changeGroup:this.changeGroup.bind(this)})},initBands:function(a){this.bands=new BandGroup({activedId:a,changeGroup:this.changeGroup.bind(this)})},request:function(f,g,h,i){if(!this._pin)this._pin=new LoadPin();if(!i)i='\u8bfb\u53d6\u6570\u636e';var j=this._pin.show(i+'...');var k=this.options.debug;var l=new Date();var m=$('req-state');if(m)m.set('html',i+'...');var n=function(a,b){j.hide();var c=Xml.getNode(b,'//Result');var d=c.Ticks||'';var e='\u5b8c\u6210 (\u6536\u5230 '+a.length+' \u5b57\u8282, \u7528\u65f6 '+l.span()+'/'+d+' \u6beb\u79d2)';if(m)m.set('html',i+e);if(h)h(b,c.State,a)};var o=function(a){j.hide();var b='\u9519\u8bef, \u4ee3\u7801 '+a.status;if(m)m.set('html',i+b);if(k)alert('req fail: '+f+'\n'+a.responseText);else alert('\u7f51\u7edc\u9519\u8bef\u6216\u670d\u52a1\u5668\u7ef4\u62a4\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002')};if(f.indexOf('/')<0)f='/admin/'+f;if(this.options.udebug&&g.Action)f+='?_d='+g.Action;var p=new Request({url:f,data:g,onSuccess:n,onFailure:o});if(f.indexOf(':')>-1)p.headers={};p.send()},getParam:function(b,c,d,e){var f=this.current;var g=f[c]||{};var h;if(typeOf(b)=='element'){h={};d.split(',').each(function(p){var n=p=='Page'?'page':'_'+p;var a=b.get(n);if(a==null){if(p=='Page')a='1';else if(g[p])a=g[p];else a=''};h[p]=a})}else{h=b||g};if(e)Object.append(h,e);var j=false;var k=[];for(var i in h)k.push(h[i]);var l=k.join(',');var m=c+'_flag';if(f[m]!=l){j=true;f[m]=l;f[c]=h};return{data:h,changed:j}},getAvatar:function(a,b){if(typeOf(a)!='string')a=a.toString();var p=a.length>3?a.substr(0,a.length-3):'0';var c=this.options.sitez+'/dat/avatar/'+p+'/'+a+'.jpg';if(b)c+='?t='+Number.random(1,999);return c},getAvatarHtml:function(a,b,c){var d=' href="http://my'+this.options.domain+'/{Account}"';var s='<div class="avatar">'+(a>0?'<a'+d+' style="background-image:url({Avatar})"></a>':'')+'</div>'+(b?'<div><a'+d+' title="{NickName}">{NickName}</a>{Stamp}</div>':'');c=c?c.utc('s'):'';return s.substitute({Account:a,Avatar:this.getAvatar(a),NickName:b||a,Stamp:c})},logout:function(a){var b=new StickDlg({stickTo:a,html:'\u786e\u5b9a\u8981\u9000\u51fa\u5417\uff1f',align:'right',ok:this.relogin.bind(this)})},relogin:function(){this.passport.clear();location.reload();return true}});App.implement({initForm:function(c,d,e,f){var g=Browser.placeholderSupport;if(!g)c.getElements('[placeholder]').each(function(a){new OverText(a)});c.updateOverText=function(){if(!g)c.getElements('[placeholder]').each(function(a){a.fireEvent('change')})};c.warn=function(a,b){if(!b)b=c.getElement('[type=submit]');new StickDlg({stickTo:b||c,html:a||'Error'});return false};var h=function(a){c.warn('\u63d0\u4ea4\u5931\u8d25, \u8bf7\u7a0d\u540e\u518d\u8bd5')};if(d.indexOf('/')<0)d='/admin/'+d;if(this.options.udebug&&c['Action'])d+='?_d='+c['Action'].value;new FormValid(c,{url:d,checkout:f,success:e,failure:h})},applyDataToForm:function(a,b){var c=a.elements;for(var i=0,j=c.length;i<j;i++){var d=c[i];var p=d.getAttribute('name');if(!p||p=='Action'||p=='Mode'||!b[p])continue;var e=b[p];switch(d.getAttribute('type')){case'checkbox':d.checked=e==d.value;break;case'radio':d.checked=e==d.value;break;default:d.value=e}};return b},applyFormToData:function(a,b,c){var d=a.elements;for(var i=0,j=d.length;i<j;i++){var e=d[i];var p=e.getAttribute('name');if(!p||p=='Action'||p=='Mode'||(c&&c.hasOwnProperty(p)))continue;switch(e.getAttribute('type')){case'checkbox':b[p]=e.checked?e.value:'';break;case'radio':if(e.checked)b[p]=e.value;break;default:b[p]=e.value}};if(c)Object.append(b,c);return b},getTableRowData:function(a,b){var c=a.lastRow;var d=c[b||'getLast']().get('_data');return JSON.decode(unescape(d))},applyTableRowToForm:function(a,b,c){var d=this.getTableRowData(a,c);if(d)this.applyDataToForm(b,d);return d},showTip:function(a,b){new StickDlg({stickTo:a,html:b})},viewSibling:function(a,b,c){var d=$gp(c,'_tag','next');var e=a.findSibling(b,d);if(e=='0')new StickDlg({stickTo:c,align:'left',html:'\u5df2\u7ecf\u662f'+(d=='next'?'\u6700\u540e\u4e00\u4e2a':'\u7b2c\u4e00\u4e2a')});return e},checkSelected:function(a,b){if(!b.selected()){new StickDlg({stickTo:a,html:'\u8bf7\u5148\u4ece\u8868\u683c\u4e2d\u9009\u62e9\u8bb0\u5f55'});return false};return true},removeTableRow:function(a,b,c,d){var e=b.checked();if(e.length==0)return this.showTip(a,'\u8bf7\u5148\u9009\u62e9\u8981\u5220\u9664\u7684\u8bb0\u5f55');var f=new StickDlg({stickTo:a,html:d||'\u8981\u5220\u9664\u9009\u5b9a\u7684\u8bb0\u5f55\u5417\uff1f',ok:function(){b.remove(e);if(c)c(e);return true}})},initMCE:function(a,b){tinyMCE.init({elements:typeof a=='string'?a:'',mode:'exact',content_css:b||this.options.mceCss,theme:'advanced',language:'zh-cn',plugins:"safari,table,advimage,advlist,advlink,emotions,insertdatetime,media,searchreplace,contextmenu,paste,noneditable,visualchars,inlinepopups",theme_advanced_font_sizes:"\u4e09\u53f7=16pt,\u5c0f\u4e09=15pt,\u56db\u53f7=14pt,\u5c0f\u56db=12pt,\u4e94\u53f7=14px,\u5c0f\u4e94=9pt",theme_advanced_buttons1:"cut,copy,paste,pastetext,pasteword,|,search,|,undo,redo,|,link,unlink,anchor,image,media,|,bullist,numlist,|,insertdate,inserttime,|,help,code",theme_advanced_buttons2:"formatselect,fontselect,fontsizeselect,bold,italic,underline,|,forecolor,backcolor,|,justifyleft,justifycenter,justifyright,justifyfull,|,outdent,indent",theme_advanced_buttons3:"tablecontrols,visualaid,|,strikethrough,sub,sup,|,hr,charmap,emotions,|,cleanup,removeformat",theme_advanced_fonts:"\u5b8b\u4f53=verdana,\u5b8b\u4f53;\u9ed1\u4f53=\u9ed1\u4f53;\u6977\u4f53=\u6977\u4f53,\u6977\u4f53_GB2312;\u4eff\u5b8b=\u4eff\u5b8b,\u4eff\u5b8b_GB2312;\u96b6\u4e66=\u96b6\u4e66;Arial=arial,helvetica,sans-serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Tahoma=tahoma,arial,helvetica,sans-serif;Times New Roman=times new roman,times;Verdana=verdana",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_blockformats:'p,div,h1,h2,h3,pre',theme_advanced_resizing:false,relative_urls:false,remove_script_host:false,convert_urls:true})}});var Passport=new Class({initialize:function(a){var b=location.host.toLowerCase();this.domain=b.substr(b.indexOf('.')+1);this.update();if(!a)window.addEvent('focus',this.watch.bind(this))},update:function(){this.CP=Cookie.read('CP');this.UID=Cookie.read('UID')||'';this.UN=Cookie.read('UN')||''},parse:function(a,b){var c=Xml.getNode(a,'//Passport');this.account=c.Account||'0';this.nickName=c.NickName||'-';this.role=c.Role||'-1';if(b)Object.append(b,{account:this.account,nickName:this.nickName,role:this.role})},watch:function(){if(Cookie.read('CP')==this.CP)return;PopupDlg.alert('\u767b\u5f55\u8eab\u4efd\u5df2\u6539\u53d8\uff0c\u8bf7\u5237\u65b0\u9875\u9762\u3002')},clear:function(){['CP','UID','UN','CA'].each(function(a){Cookie.dispose(a,{path:'/'+(a=='CA'?'admin':''),domain:this.domain})},this)}});
